(function(){'use strict';var t=Math.PI,a=Math.sqrt,l=Math.pow,o=Math.round,r=Number.isInteger;function e(){var P=Math.hypot;function t(e,t){let a,l,o,r,i,n,d,c,g=!1,p=!1;null!==s.svg.main.group&&(a=s.svg.main.group.transform.baseVal[0].matrix.a,l=s.svg.main.group.transform.baseVal[0].matrix.d,o=s.svg.main.group.transform.baseVal[0].matrix.e,r=s.svg.main.group.transform.baseVal[0].matrix.f,g=!0),null!==s.svg.legend.group&&(i=s.svg.legend.group.transform.baseVal[0].matrix.a,n=s.svg.legend.group.transform.baseVal[0].matrix.d,d=s.svg.legend.group.transform.baseVal[0].matrix.e,c=s.svg.legend.group.transform.baseVal[0].matrix.f,p=!0),f.update(),s.svg.main.group=document.getElementById("svg_main"),s.svg.legend.group=document.getElementById("svg_legend"),g&&null!==s.svg.main.group&&!e&&(s.svg.main.group.transform.baseVal[0].matrix.a=a,s.svg.main.group.transform.baseVal[0].matrix.d=l,s.svg.main.group.transform.baseVal[0].matrix.e=o,s.svg.main.group.transform.baseVal[0].matrix.f=r),null!==s.svg.legend.group&&(s.svg.legend.init.e=s.svg.legend.group.transform.baseVal[0].matrix.e,s.svg.legend.init.f=s.svg.legend.group.transform.baseVal[0].matrix.f,p&&!t&&(s.svg.legend.group.transform.baseVal[0].matrix.a=i,s.svg.legend.group.transform.baseVal[0].matrix.d=n,s.svg.legend.group.transform.baseVal[0].matrix.e=d,s.svg.legend.group.transform.baseVal[0].matrix.f=c))}function a(e,t){if(!s.list.direct_edit.active){let a=_.getSelected();if(a){s.list.direct_edit.active=!0,s.list.direct_edit.target=t;let l=$(document.getElementById("phasor_"+e));t===L.phasor.symbol?s.list.direct_edit.box=l.find("span.phasor_symbol"):t===L.phasor.label?s.list.direct_edit.box=l.find("span.phasor_label"):t===L.phasor.parent?s.list.direct_edit.box=l.find("span.phasor_parent"):void 0;s.list.direct_edit.label=s.list.direct_edit.box.find("span"),s.list.direct_edit.input=s.list.direct_edit.box.find("input"),s.list.direct_edit.label.addClass("hidden"),s.list.direct_edit.input.removeClass("hidden"),s.list.direct_edit.input.focus();t===L.phasor.symbol?(s.list.direct_edit.input.val(a.symbol),s.list.direct_edit.input[0].setSelectionRange(a.symbol.length,a.symbol.length)):t===L.phasor.label?(s.list.direct_edit.input.val(a.label),s.list.direct_edit.input[0].setSelectionRange(a.label.length,a.label.length)):t===L.phasor.parent?a.parent?(s.list.direct_edit.input.val(a.parent.symbol),s.list.direct_edit.input[0].setSelectionRange(a.parent.symbol.length,a.parent.symbol.length)):s.list.direct_edit.input.val(""):void 0}}}function l(e){if(s.list.direct_edit.active){let a=!1,l=_.getSelected(),o=s.list.direct_edit.input.val();if(!l)return;switch(s.list.direct_edit.target){case L.phasor.symbol:a=_.set(l,_.en.symbol,o);break;case L.phasor.label:a=_.set(l,_.en.label,o);break;case L.phasor.parent:a=_.set(l,_.en.parent,o);}(a||!e)&&(s.list.direct_edit.input.addClass("hidden"),s.list.direct_edit.label.removeClass("hidden"),s.list.direct_edit.active=!1,a&&t(!1,s.list.direct_edit.target==L.phasor.label))}}function o(s){s.stopPropagation(),s.preventDefault()}function r(t){if(s.svg.action!=L.svg_action.none&&s.svg.action!=L.svg_action.pan)return;s.list.direct_edit.active&&l(!1),t.stopPropagation(),t.preventDefault(),s.list.exp_el&&s.list.exp_el.blur();let a=s.svg.jqel[0].getScreenCTM();if(t.touches){if(2<=t.touches.length)return void(2!=t.touches.length||s.locked||(s.svg.main.offset.distance=P(t.touches[0].pageX-t.touches[1].pageX,t.touches[0].pageY-t.touches[1].pageY),s.svg.main.offset.scale=s.svg.main.group.transform.baseVal[0].matrix.a,s.svg.main.offset.x=(.5*(t.touches[0].pageX+t.touches[1].pageX)-a.e)/a.a,s.svg.main.offset.y=(.5*(t.touches[0].pageY+t.touches[1].pageY)-a.f)/a.d,s.svg.action=L.svg_action.zoom,s.svg.main.width=s.svg.jqel.width()));t=t.touches[0]}if(200>Date.now()-s.svg.main.clicktime)return!s.locked&&s.svg.main.group&&(s.svg.main.group.transform.baseVal[0].matrix.a=1,s.svg.main.group.transform.baseVal[0].matrix.d=1,s.svg.main.group.transform.baseVal[0].matrix.e=0,s.svg.main.group.transform.baseVal[0].matrix.f=0),void(s.svg.legend.group&&(s.svg.legend.group.transform.baseVal[0].matrix.a=1,s.svg.legend.group.transform.baseVal[0].matrix.d=1,s.svg.legend.group.transform.baseVal[0].matrix.e=s.svg.legend.init.e,s.svg.legend.group.transform.baseVal[0].matrix.f=s.svg.legend.init.f));s.svg.main.pos.x=(t.clientX-a.e)/a.a,s.svg.main.pos.y=(t.clientY-a.f)/a.d;let o,r,n,d;for(let e=0;e<f.phasordrag.points.length;e++)if(n=(s.svg.main.pos.x-s.svg.main.group.transform.baseVal[0].matrix.e)/s.svg.main.group.transform.baseVal[0].matrix.a,d=(s.svg.main.pos.y-s.svg.main.group.transform.baseVal[0].matrix.f)/s.svg.main.group.transform.baseVal[0].matrix.d,o=n-f.phasordrag.points[e].x,r=d-f.phasordrag.points[e].y,o*o+r*r<=f.phasordrag.radius_squard)return _.setExcSelected(f.phasordrag.points[e].id),s.svg.action=L.svg_action.phasor_drag,s.svg.phasor.line=document.getElementById("svg_phasor_"+f.phasordrag.points[e].id).children[1],s.svg.phasor.line.nextSibling.setAttribute("class","invisible"),s.svg.phasor.line.previousSibling.setAttribute("class","invisible"),s.svg.phasor.line.setAttribute("class",""),s.svg.phasor.line.setAttribute("x2",o),s.svg.phasor.line.setAttribute("y2",r),void _.setSelectionInfo();"svg_phasor_"===t.target.parentNode.id.substr(0,11)?(t.ctrlKey?_.setSelected(t.target.parentNode.id.substr(11),!0):_.setExcSelected(t.target.parentNode.id.substr(11)),_.setSelectionInfo()):(_.clearSelection(),_.setSelectionInfo(),"svg_legend"==t.target.parentNode.id?("circle"==t.target.tagName?(s.svg.action=L.svg_action.legend_scale,s.svg.legend.scale_offset.x=s.svg.legend.group.transform.baseVal[0].matrix.a-s.svg.main.pos.x/s.svg.legend.group.firstElementChild.width.baseVal.value,s.svg.legend.scale_offset.y=s.svg.legend.group.transform.baseVal[0].matrix.d-s.svg.main.pos.x/s.svg.legend.group.firstElementChild.width.baseVal.value):(s.svg.action=L.svg_action.legend_drag,s.svg.legend.offset.x=s.svg.main.pos.x-s.svg.legend.group.transform.baseVal[0].matrix.e,s.svg.legend.offset.y=s.svg.main.pos.y-s.svg.legend.group.transform.baseVal[0].matrix.f),s.svg.legend.group.getElementsByTagName("circle")[0].setAttribute("class","svg_legend_scale"),s.svg.legend.selected=!0):(s.svg.legend.selected&&(s.svg.legend.group.getElementsByTagName("circle")[0].setAttribute("class","invisible"),s.svg.legend.selected=!1),!s.locked&&(s.svg.action=L.svg_action.pan,s.svg.main.offset.x=s.svg.main.pos.x-s.svg.main.group.transform.baseVal[0].matrix.e,s.svg.main.offset.y=s.svg.main.pos.y-s.svg.main.group.transform.baseVal[0].matrix.f),s.svg.main.clicktime=Date.now()))}function i(t){if(t.stopPropagation(),t.preventDefault(),t.touches){if(2<=t.touches.length){if(s.svg.action==L.svg_action.zoom&&2===t.touches.length){let e=P(t.touches[0].pageX-t.touches[1].pageX,t.touches[0].pageY-t.touches[1].pageY),a=s.svg.main.offset.scale+(e-s.svg.main.offset.distance)/s.svg.main.width;s.svg.main.group.transform.baseVal[0].matrix.e+=(s.svg.main.group.transform.baseVal[0].matrix.a-a)*(s.svg.main.offset.x-s.svg.main.group.transform.baseVal[0].matrix.e)/s.svg.main.group.transform.baseVal[0].matrix.a,s.svg.main.group.transform.baseVal[0].matrix.f+=(s.svg.main.group.transform.baseVal[0].matrix.d-a)*(s.svg.main.offset.y-s.svg.main.group.transform.baseVal[0].matrix.f)/s.svg.main.group.transform.baseVal[0].matrix.d,s.svg.main.group.transform.baseVal[0].matrix.a=a,s.svg.main.group.transform.baseVal[0].matrix.d=a}return}t=t.touches[0]}let a=s.svg.jqel[0].getScreenCTM();switch(s.svg.main.pos.x=(t.clientX-a.e)/a.a,s.svg.main.pos.y=(t.clientY-a.f)/a.d,s.svg.action){case L.svg_action.phasor_drag:{s.svg.phasor.line.setAttribute("x2",(s.svg.main.pos.x-s.svg.main.group.transform.baseVal[0].matrix.e)/s.svg.main.group.transform.baseVal[0].matrix.a),s.svg.phasor.line.setAttribute("y2",(s.svg.main.pos.y-s.svg.main.group.transform.baseVal[0].matrix.f)/s.svg.main.group.transform.baseVal[0].matrix.d);break}case L.svg_action.legend_drag:{s.svg.legend.group.transform.baseVal[0].matrix.e=s.svg.main.pos.x-s.svg.legend.offset.x,s.svg.legend.group.transform.baseVal[0].matrix.f=s.svg.main.pos.y-s.svg.legend.offset.y;break}case L.svg_action.legend_scale:{let e=s.svg.legend.scale_offset.x+s.svg.main.pos.x/s.svg.legend.group.firstElementChild.width.baseVal.value,t=s.svg.legend.scale_offset.y+s.svg.main.pos.y/s.svg.legend.group.firstElementChild.width.baseVal.value;.5>=e&&(e=.5),e>=t?(s.svg.legend.group.transform.baseVal[0].matrix.a=e,s.svg.legend.group.transform.baseVal[0].matrix.d=e):(s.svg.legend.group.transform.baseVal[0].matrix.a=t,s.svg.legend.group.transform.baseVal[0].matrix.d=t);break}case L.svg_action.pan:{s.svg.main.group.transform.baseVal[0].matrix.e=s.svg.main.pos.x-s.svg.main.offset.x,s.svg.main.group.transform.baseVal[0].matrix.f=s.svg.main.pos.y-s.svg.main.offset.y;break}}}function n(){if(s.svg.action==L.svg_action.phasor_drag){let e=_.getSelected();if(e){let a=f.getScale(),l=s.svg.phasor.line.getAttribute("x2")/a-e.sx,o=-1*s.svg.phasor.line.getAttribute("y2")/a-e.sy;_.set(e,_.en.position,l,o),_.setSelectionInfo(),t(!1,!1)}}s.svg.action=L.svg_action.none}function c(a){if(a.stopPropagation(),s.list.touch.done)return;if(s.list.direct_edit.active)return void(a.target!==s.list.direct_edit.input[0]&&l(!1));let e=$(a.target).closest("div.form-row"),o=e.data("id");if(a.ctrlKey)_.setSelected(o,!0);else{let e=_.setExcSelected(o),l=a.target.getAttribute("data-ident");e&&l&&("system"===l?_.set(e,_.en.nextsystem):"visible"===l?(_.set(e,_.en.visible,a.target.checked),t(!1,!1)):"exp"===l?(s.list.exp_el=$(a.target),s.list.exp_el.focus()):void 0)}_.setSelectionInfo()}function g(t){if(s.list.direct_edit.active||s.list.touch.done)return;t.stopPropagation();let e=$(t.target).closest("div.form-row"),l=e.data("id"),o=t.target.getAttribute("data-ident");"label"===o?a(l,L.phasor.label):"parent"===o?a(l,L.phasor.parent):"symbol"===o?a(l,L.phasor.symbol):void 0}function p(s){s.stopPropagation();let e=$(s.target).closest("div.form-row"),a=e.data("id"),l=s.target.getAttribute("data-ident");"exp"===l?(_.parse(a,s.target.value),t(!1,!1)):void 0}function m(t){if(t.stopPropagation(),s.list.direct_edit.active)return void t.preventDefault();s.list.touch.id=$(t.target).closest("div.form-row").data("id"),s.list.touch.done=!1,s.list.touch.timer=setTimeout(v,d.longtap_time),s.list.touch.target=-1;let e=t.target.getAttribute("data-ident");e&&("label"===e?s.list.touch.target=L.phasor.label:"parent"===e?s.list.touch.target=L.phasor.parent:"symbol"===e?s.list.touch.target=L.phasor.symbol:void 0)}function h(){s.list.touch.timer&&clearTimeout(s.list.touch.timer)}function u(){s.list.touch.timer&&clearTimeout(s.list.touch.timer)}function x(){s.list.touch.timer&&clearTimeout(s.list.touch.timer);var e=Date.now();!s.list.touch.done&&e-s.list.touch.last<=d.doubletap_time&&(0<=s.list.touch.target&&2>=s.list.touch.target&&a(s.list.touch.id,s.list.touch.target),s.list.touch.done=!0),s.list.touch.last=e}function v(){s.list.touch.done=!0,_.setSelected(s.list.touch.id,!0),_.setSelectionInfo()}function k(t){s.svg.legend.selected&&(s.svg.legend.selected=!1,s.svg.legend.group&&s.svg.legend.group.getElementsByTagName("circle")[0].setAttribute("class","invisible")),s.list.direct_edit.active?t.target!==s.list.direct_edit.input[0]&&l(!1):!w.isVisible()&&"BUTTON"!==t.target.tagName&&"phasor_info"!==t.target.id&&(_.clearSelection(),s.list.info_el.html(""))}function z(t){switch(t.which){case 46:w.isVisible()||"INPUT"===t.target.nodeName||_.isSelectionEmpty()||(t.preventDefault(),t.stopPropagation(),w.show(w.en.delete));break;case 13:s.list.direct_edit.active&&(t.preventDefault(),t.stopPropagation(),l(!0));}}function S(e){s.locked=!!e,$("#phasor_list").sortable("option","disabled",s.locked)}function A(e){y.loadString(e),t(!0,!0)}function C(){w.show(w.en.edit)}function q(){w.show(w.en.settings)}function N(){w.show(w.en.delete)}function E(){w.show(w.en.net,"upload")}function V(){w.show(w.en.net,"download")}function j(){w.show(w.en.info)}function I(e){w.show(w.en.save,e)}function O(){let e=_.add(),t=$(document.getElementById("phasor_"+e)).find("input.phasor_exp");t.focus(),s.list.exp_el=t}function B(){s.svg.main.group.transform.baseVal[0].matrix.a=1,s.svg.main.group.transform.baseVal[0].matrix.d=1,s.svg.main.group.transform.baseVal[0].matrix.e=0,s.svg.main.group.transform.baseVal[0].matrix.f=0,_.reset(),b.reset(),t(!0,!0)}const L={phasor:{label:0,symbol:1,parent:2,system:3,visibility:4,expression:5},svg_action:{none:0,pan:1,zoom:2,phasor_drag:3,legend_drag:4,legend_scale:5}};Object.freeze(L);var s={svg:{jqel:$("#svg"),action:L.svg_action.none,main:{group:null,width:0,clicktime:0,offset:{x:0,y:0,scale:0,distance:0},pos:{x:0,y:0}},legend:{group:null,selected:!1,init:{e:0,f:0},offset:{x:0,y:0},scale_offset:{x:0,y:0}},phasor:{line:0}},list:{exp_el:null,info_el:$("#phasor_info"),direct_edit:{active:!1,target:0,box:0,input:0,label:0},touch:{timer:null,done:!1,id:0,last:0,target:-1}},locked:!0};(function(){$(document).keyup(z),$("body").on("click",k),s.svg.jqel.on("click",o),s.svg.jqel.on("mousedown",r),s.svg.jqel.on("touchstart",r),s.svg.jqel.on("mousemove",i),s.svg.jqel.on("touchmove",i),s.svg.jqel.on("mouseup",n),s.svg.jqel.on("touchend",n),s.svg.jqel.on("mouseleave",n),s.svg.jqel.on("touchcancel",n);let e=$("#phasor_list");e.on("click",c),e.on("dblclick",g),e.on("touchstart",m),e.on("touchmove",h),e.on("touchcancel",u),e.on("touchend",x),e.on("input",p),e.sortable({revert:!0,disabled:!0}),window.phasorviz={edit:C,settings:q,info:j,del:N,save:I,load:A,add:O,reset:B,setlocked:S,upload:E,download:V},w.setup(t),_.add(1,1),t(!1,!1)})()}class i{constructor(e){"undefined"!=typeof e&&this.set(e)||(this.hex="#000000",this.rgba="rgba(0, 0, 0, 1)",this.r=0,this.g=0,this.b=0,this.a=1)}set(e){if("string"==typeof e){if(!("#"==e[0])){var s=e.match(/^rgba?\((\d{1,3}), ?(\d{1,3}), ?(\d{1,3}),? ?((0|1)\.?\d*?)?\)$/);if(s){for(var a="#",l=[],o=1;4>o;o++){l[o-1]=+s[o];var n=l[o-1].toString(16);a+=1==n.length?"0"+n:n}return this.hex=a,this.r=l[0],this.g=l[1],this.b=l[2],this.a=s[4]?+s[4]:1,this.rgba="rgba("+this.r+", "+this.g+", "+this.b+", "+this.a+")",!0}}else if(7==e.length){let s=parseInt(e.substr(1,2),16),t=parseInt(e.substr(3,2),16),a=parseInt(e.substr(5,2),16);if(!isNaN(s)&&!isNaN(t)&&!isNaN(a)&&r(s)&&r(t)&&r(a)&&0<=s&&255>=s&&0<=t&&255>=t&&0<=a&&255>=a)return this.hex=e,this.alpha=1,this.r=s,this.g=t,this.b=a,this.rgba="rgba("+this.r+", "+this.g+", "+this.b+", "+this.a+")",!0}return!1}if("object"==typeof e){if("number"==typeof e.r&&r(e.r)&&0<=e.r&&255>=e.r&&"number"==typeof e.g&&r(e.g)&&0<=e.g&&255>=e.g&&"number"==typeof e.b&&r(e.b)&&0<=e.b&&255>=e.b&&"number"==typeof e.a&&0<=e.a&&1>=e.a){this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this.rgba="rgba("+this.r+", "+this.g+", "+this.b+", "+this.a+")";let s="#",a=this.r.toString(16);return s+=1==a.length?"0"+a:a,a=this.g.toString(16),s+=1==a.length?"0"+a:a,a=this.b.toString(16),s+=1==a.length?"0"+a:a,this.hex=s,!0}return!1}}equals(e){return this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}}const d={version:1,appmode:!0,svg:{ns:"http://www.w3.org/2000/svg",publicid:"-//W3C//DTD SVG 1.1//EN",systemid:"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"},system:{none:0,cartesean:1,polar_rad:2,polar_deg:3,count:3},system_labels:["","c","&Phi;","&Phi;&deg;"],stroke_styles:[{label:"solid",value:0},{label:"dotted",value:2},{label:"dashed",value:6}],arrow_types:[{label:"none",length:0,angle:0},{label:"flat",length:.11,angle:.89759790102,filled:!1},{label:"flat - filled",length:.11,angle:.89759790102,filled:!0},{label:"normal",length:.1,angle:.62831853071,filled:!1},{label:"normal - filled",length:.1,angle:.62831853071,filled:!0},{label:"pointed",length:.12,angle:.41887902047,filled:!1},{label:"pointed - filled",length:.12,angle:.41887902047,filled:!0}],arrow_size:{min:5,max:30,factor:.1},phasor_skins:[{label:"Standard",classname:"phasor_style_1"},{label:"Vida Loca",classname:"phasor_style_2"},{label:"Whiskeyapprox",classname:"phasor_style_3"},{label:"Valhalla",classname:"phasor_style_4"}],default_phasor:{width:4,arrow:5,arrow_size:10,outline_width:0},phasor_colors:[new i("rgba(255, 0, 0, 1)"),new i("rgba(255, 228, 0, 1)"),new i("rgba(0, 0, 255, 1)"),new i("rgba(0, 51, 0, 1)"),new i("rgba(153, 0, 153, 1)")],colors:{legend_scale_circle:new i("rgba(250,10,10,0.5)"),invisible:new i("rgba(0, 0, 0, 0)")},viewbox_base:1e3,max_outline_width:5,max_phasor_width:8,tick_length:.015,text_size:{min:7,max:20,factor:.1},label_size:1,rounding_precision:1e5,symbol_regex:/^[a-zA-Z_]+[a-zA-Z0-9_]*$/,label_regex:/^[^<>"']*$/,code_regex:/^[A-Z0-9]{6}$/,ajax_url:"https://phasorviz.cerberus-design.de/ajax.php",lineheight_steps:[4,8,12],max_filesize:1024e3,doubletap_time:500,longtap_time:500,max_label_length:64,files:{default_name:"phasorviz",max_name_length:64,png:{width:{default:1e3,min:10,max:1e4},height:{default:1e3,min:10,max:1e4},background_color:"rgb(255,255,255,1)"},svg:{width:{default:600,min:10,max:1e4},height:{default:600,min:10,max:1e4}}}};Object.freeze(d);const c={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"},g={round:function(e){if(1<e)e=o(e*d.rounding_precision)/d.rounding_precision;else if(1>e){let t=""+e,s=0;for(;s<t.length&&("0"==t[s]||"."==t[s]||"-"==t[s]);s++);"-"===t[0]&&s--;let a=l(10,s)*(d.rounding_precision/100);e=o(e*a)/a}return e},escapeHtml:function(e){return(e+"").replace(/[&<>"'/]/g,function(e){return c[e]})},checkObj:function(e){if("object"!=typeof e)throw new Error},checkInt:function(e,s,t){if("number"!=typeof e||!r(e)||e<s||e>t)throw new Error},checkString:function(e,s){if("string"!=typeof e||e.length>s)throw new Error},checkBool:function(e){if("boolean"!=typeof e)throw new Error},checkNumber:function(e,s){var t=Number.isFinite;if("number"!=typeof e||!t(e)||e<s)throw new Error},getBrowserString:function(){var e,s=navigator.userAgent,t=s.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];return /trident/i.test(t[1])?(e=/\brv[ :]+(\d+)/g.exec(s)||[],"IE "+(e[1]||"")):"Chrome"===t[1]&&(e=s.match(/\b(OPR|Edge?)\/(\d+)/),null!=e)?e.slice(1).join(" ").replace("OPR","Opera").replace("Edg ","Edge "):(t=t[2]?[t[1],t[2]]:[navigator.appName,navigator.appVersion,"-?"],null!=(e=s.match(/version\/(\d+)/i))&&t.splice(1,1,e[1]),t.join(" "))}};Object.freeze(g);class m{constructor(e,s,t,a,l){this.id=e,this.parent=null,this.value=math.complex(s,t),this.valid=!0,this.valid_exp=!0,this.valid_parent=!0,this.sx=0,this.sy=0,this.fx=0,this.fy=0,this.length=0,this.coord_strings=[],this.width=d.default_phasor.width,this.arrow=d.default_phasor.arrow,this.arrow_size=d.default_phasor.arrow_size,this.visible=!0,this.outline_width=d.default_phasor.outline_width,this.dependencies=[],this.system=d.system.cartesean,this.label=l,this.symbol="",this.color_index=a,this.color=new i(d.phasor_colors[a]),this.outline_color=new i(d.phasor_colors[a]),this.expcode=null,this.skin=0}}var _=function(){var S=Number.NaN;function e(e,s){"string"==typeof e&&""!=e&&(e=+e),"number"==typeof e&&isFinite(e)||(e=S),"string"==typeof s&&""!=s&&(s=+s),"number"==typeof s&&isFinite(s)||(s=S);let t;q.free_ids.length?t=q.free_ids.pop():(t=q.next_id,q.next_id++);let a=0,o=0;for(;q.color_usage[a]!=o;)a++,a>=d.phasor_colors.length&&(a=0,o++);q.color_usage[a]++,q.label_index++;let r=new m(t,e,s,a,"Phasor "+q.label_index);return r.valid_exp=!(isNaN(e)||isNaN(s)),r.valid=r.valid_exp,z(r),C.set(t,r),q.arr.push(r),r.valid&&w(),h.add(r),h.updatePhasor(r,h.en.u.expclass),h.updateLineHeight(q.arr.length),l(0<q.selection.length),t}function s(e,s){let t=o(e);if(!t)return!1;try{let e=math.parse(s);t.system=k(e),t.dependencies=[],q.phasor=t,e.traverse(c),t.expcode=e.compile(),_(t),b(t),r(t,!0),z(t)}catch(s){r(t,!1),t.system=d.system.none}v(t),w(),h.updatePhasor(t,h.en.u.system),h.setInfo(q.selection)}function l(e){d.appmode?APP.enableButtons(e):(h.enableButton(h.en.btn.del,e),h.enableButton(h.en.btn.edit,e))}function o(e){return!(e instanceof m)&&("string"==typeof e&&(e=+e),e=C.get(e),"undefined"==typeof e)?null:e}function r(e,s){if(e.valid_exp!=s){e.valid_exp=s,e.valid=e.valid_exp&&e.valid_parent,0<e.symbol.length&&(e.valid_exp?q.scope[e.symbol]=e.value:delete q.scope[e.symbol]),h.updatePhasor(e,h.en.u.expclass);for(let s=0;s<q.arr.length;s++)if(q.arr[s]!==e&&(q.arr[s].parent===e&&n(q.arr[s],e.valid),0<e.symbol.length))for(let t=0;t<q.arr[s].dependencies.length;t++)q.arr[s].dependencies[t]===e&&r(q.arr[s],e.valid_exp)}}function n(e,s){if(e.valid_parent!==s){e.valid_parent=s,e.valid=e.valid_exp&&e.valid_parent,h.updatePhasor(e,h.en.u.parentclass);for(let s=0;s<q.arr.length;s++)q.arr[s].parent===e&&n(q.arr[s],e.valid)}}function c(e){if("SymbolNode"===e.type&&1<=e.name.length&&!N.includes(e.name))for(let s=0;s<q.arr.length;s++)if(e.name===q.arr[s].symbol){q.phasor.dependencies.includes(q.arr[s])||q.phasor.dependencies.push(q.arr[s]);break}}function _(e,s){"undefined"==typeof s&&(s=e);for(let t=0;t<e.dependencies.length;t++){if(e.dependencies[t]===s)throw Error("looping dependency");_(e.dependencies[t],s)}}function u(){var s=0;for(let e=0;e<q.arr.length;e++)if(!q.arr[e].valid_exp)try{let s=$("#phasor_"+q.arr[e].id+" input.phasor_exp").val(),t=math.parse(s);q.arr[e].system=k(t),q.arr[e].dependencies=[],q.phasor=q.arr[e],t.traverse(c),q.arr[e].expcode=t.compile(),_(q.arr[e]),b(q.arr[e]),r(q.arr[e],!0),z(q.arr[e])}catch(t){s++}finally{v(q.arr[e]),h.updatePhasor(q.arr[e],h.en.u.system)}return s}function b(e){let s=e.expcode.evaluate(q.scope);if("number"==typeof s&&isFinite(s))e.value.re=s,e.value.im=0;else if("object"==typeof s&&"number"==typeof s.im&&isFinite(s.im)&&isFinite(s.re))e.value.re=s.re,e.value.im=s.im;else throw Error("evaluation failed")}function v(e){let s=new Set;s.add(e),f(s,e)}function f(e,s){for(let t=0;t<q.arr.length;t++)if(!e.has(q.arr[t])&&q.arr[t].dependencies.includes(s)){if(s.valid)try{b(q.arr[t]),r(q.arr[t],!0)}catch(s){r(q.arr[t],!1)}else r(q.arr[t],!1);z(q.arr[t]),e.add(q.arr[t]),f(e,q.arr[t])}}function y(e,s){"undefined"==typeof s&&(s=e.parent,e.sx=0,e.sy=0),s?(e.sx+=s.value.re,e.sy+=s.value.im,y(e,s.parent)):(e.fx=e.sx+e.value.re,e.fy=e.sy+e.value.im)}function w(){q.max_phasor_len=0;let e,s;for(let t=0;t<q.arr.length;t++)q.arr[t].valid&&q.arr[t].visible&&(y(q.arr[t]),e=a(q.arr[t].sx*q.arr[t].sx+q.arr[t].sy*q.arr[t].sy),s=a(q.arr[t].fx*q.arr[t].fx+q.arr[t].fy*q.arr[t].fy),e>q.max_phasor_len&&(q.max_phasor_len=e),s>q.max_phasor_len&&(q.max_phasor_len=s))}function k(s){if(s.isOperatorNode){if("+"===s.op||"-"===s.op){if(2==s.args.length){if(s.args[0].isConstantNode||s.args[0].isOperatorNode&&"-"===s.args[0].op&&s.args[0].args[0].isConstantNode)if(s.args[1].isOperatorNode&&"*"===s.args[1].op&&2==s.args[1].args.length){if(s.args[1].args[1].isSymbolNode&&"i"===s.args[1].args[1].name){if(s.args[1].args[0].isConstantNode||s.args[1].args[0].isOperatorNode&&"-"===s.args[1].args[0].op&&s.args[1].args[0].args[0].isConstantNode)return d.system.cartesean;}else if(s.args[1].args[0].isSymbolNode&&"i"===s.args[1].args[0].name&&(s.args[1].args[1].isConstantNode||s.args[1].args[1].isOperatorNode&&"-"===s.args[1].args[1].op&&s.args[1].args[1].args[0].isConstantNode))return d.system.cartesean;}else if(s.args[1].isSymbolNode&&"i"===s.args[1].name)return d.system.cartesean;}else if(1==s.args.length&&(s.args[0].isConstantNode||s.args[0].isSymbolNode&&"i"===s.args[0].name))return d.system.cartesean;}else if("*"===s.op){if(s.args[0].isSymbolNode&&"i"===s.args[0].name&&(s.args[1].isConstantNode||"-"===s.args[1].op&&1===s.args[1].args.length&&s.args[1].args[0].isConstantNode))return d.system.cartesean;if(s.args[0].isConstantNode||"-"===s.args[0].op&&1===s.args[0].args.length&&s.args[0].args[0].isConstantNode){var t;if(s.args[1].isSymbolNode&&"i"===s.args[1].name)return d.system.cartesean;if(s.args[1].isOperatorNode&&"^"==s.args[1].op&&2==s.args[1].args.length&&s.args[1].args[0].isSymbolNode&&"e"===s.args[1].args[0].name)t=s.args[1].args[1].content;else if(s.args[1].isFunctionNode&&"exp"==s.args[1].name&&1==s.args[1].args.length)t=s.args[1].args[0];else return d.system.none;if(t.isOperatorNode&&"*"==t.op&&2==t.args.length&&t.args[0].isSymbolNode&&"i"===t.args[0].name&&(t.args[1].isConstantNode||t.args[1].isOperatorNode&&"-"===t.args[1].op&&t.args[1].args[0].isConstantNode))return d.system.polar_rad;if(t.isOperatorNode&&"/"==t.op&&t.args[1].isSymbolNode&&"pi"==t.args[1].name&&t.args[0].isOperatorNode&&"*"==t.args[0].op&&t.args[0].args[0].isSymbolNode&&"i"===t.args[0].args[0].name&&(t.args[0].args[1].isConstantNode||t.args[0].args[1].isOperatorNode&&"-"===t.args[0].args[1].op&&t.args[0].args[1].args[0].isConstantNode))return d.system.polar_rad;if(t.isOperatorNode&&"/"==t.op&&t.args[1].isConstantNode&&180==t.args[1].value&&t.args[0].isOperatorNode&&"*"==t.args[0].op&&t.args[0].args[0].isOperatorNode&&"*"==t.args[0].args[0].op&&t.args[0].args[0].args[0].isSymbolNode&&"i"==t.args[0].args[0].args[0].name&&t.args[0].args[1].isSymbolNode&&"pi"==t.args[0].args[1].name&&(t.args[0].args[0].args[1].isConstantNode||t.args[0].args[0].args[1].isOperatorNode&&"-"===t.args[0].args[0].args[1].op&&t.args[0].args[0].args[1].args[0].isConstantNode))return d.system.polar_deg}}}else if(s.isConstantNode||s.isSymbolNode&&"i"===s.name)return d.system.cartesean;return d.system.none}function z(e){var s=Math.atan2;if(e.valid){let l=g.round(e.value.re),o=g.round(e.value.im);e.length=a(e.value.re*e.value.re+e.value.im*e.value.im);let r=s(e.value.im,e.value.re);0>r&&(r=2*t+r);let i=g.round(e.length);r=g.round(r);let n=180*s(e.value.im,e.value.re)/t;0>n&&(n=360+n),n=g.round(n),e.coord_strings[0]="( "+l+" , "+o+" ) , length: "+i+" , &phi;: "+r+" rad / "+n+"&deg;",e.coord_strings[d.system.cartesean]=""+l+" + i * "+o,e.coord_strings[d.system.polar_rad]=""+i+" * e^(i * "+r+")",e.coord_strings[d.system.polar_deg]=""+i+" * e^(i * "+n+" * pi/180)"}else e.coord_strings[0]=""}const A={position:0,label:1,color:2,symbol:3,parent:4,visible:5,nextsystem:6,skin:7};Object.freeze(A);var C=new Map,q={arr:[],selection:[],scope:{},phasor:null,max_phasor_len:0,next_id:0,free_ids:[],color_usage:Array(d.phasor_colors.length),label_index:0},N=["i","e","exp","sin","cos","tan","pi"];return q.color_usage.fill(0),{get:function(e){"string"==typeof e&&(e=+e);let s=C.get(e);return"undefined"==typeof s?null:s},set:function(e,s,t,a){let l=o(e);if(!l)return!1;switch(s){case A.position:{"string"==typeof t&&""!=t&&(t=+t),"number"==typeof t&&isFinite(t)||(t=S),"string"==typeof a&&""!=a&&(a=+a),"number"==typeof a&&isFinite(a)||(a=S),l.value.re=t,l.value.im=a,r(l,!(isNaN(t)||isNaN(a))),z(l),v(l),w(),h.updatePhasor(l,h.en.u.expression);break}case A.label:{if("string"!=typeof t||0>=t.length||t.length>d.max_label_length||!t.match(d.label_regex))return!1;l.label=t,h.updatePhasor(l,h.en.u.label);break}case A.color:{if(!l.color.set(t))return!1;let e=-1;for(let s=0;s<d.phasor_colors.length;s++)if(l.color.equals(d.phasor_colors[s])){e=s;break}e!=l.color_index&&(-1!=l.color_index&&q.color_usage[l.color_index]--,-1!=e&&q.color_usage[e]++,l.color_index=e);break}case A.symbol:{if("string"!=typeof t)return!1;let e=!0;if(0<t.length)if(t.match(d.symbol_regex)&&!N.includes(t)){for(let s=0;s<q.arr.length;s++)if(q.arr[s]!==l&&t===q.arr[s].symbol){e=!1;break}}else e=!1;if(!e)return!1;if(l.symbol!==t){0<l.symbol.length&&delete q.scope[l.symbol],0<t.length&&(q.scope[t]=l.value);let e=0<l.symbol.length,s=0<t.length;if(l.symbol=t,e)for(let e=0;e<q.arr.length;e++)q.arr[e]!==l&&(q.arr[e].dependencies.includes(l)&&r(q.arr[e],!1),q.arr[e].parent===l&&(s?n(q.arr[e],l.valid):q.arr[e].parent=null,h.updatePhasor(q.arr[e],h.en.u.parent)));h.updatePhasor(l,h.en.u.symbol),l.valid_exp&&(u(),w(),h.setInfo(q.selection))}break}case A.parent:{if("string"!=typeof t)return!1;if(""===t)null!==l.parent&&(l.parent=null,h.updatePhasor(l,h.en.u.parent),w());else{let e=null;for(let s=0;s<q.arr.length;s++)if(l!==q.arr[s]&&q.arr[s].symbol===t){e=q.arr[s];for(let s=e.parent;s;){if(s===l){e=null;break}s=s.parent}break}if(!e)return!1;l.parent=e,h.updatePhasor(l,h.en.u.parent),n(l,e.valid),w()}break}case A.visible:{if("boolean"!=typeof t)return!1;l.visible=t,w();break}case A.nextsystem:{if(l.system===d.system.none)return!1;l.system++,l.system>d.system.count&&(l.system=1);let e=$(document.getElementById("phasor_"+l.id));h.updatePhasor(l,h.en.u.expression,e),h.updatePhasor(l,h.en.u.system,e);break}case A.skin:{0<=t&&t<d.phasor_skins.length&&(l.skin=t,h.updatePhasor(l,h.en.u.skin));break}default:return!1;}return!0},add:e,delete:function(e){Array.isArray(e)||(e=[e]);let s=!1,t=null;for(let a=0;a<e.length;a++){if(e[a]instanceof m)t=e[a];else if(t=C.get(e[a]),"undefined"==typeof t)continue;0<=t.color_index&&q.color_usage[t.color_index]--,""!==t.symbol&&delete q.scope[t.symbol],r(t,!1),C.delete(t.id);for(let e=0;e<q.arr.length;e++)if(q.arr[e]===t){q.arr.splice(e,1);break}for(let e=0;e<q.selection.length;e++)if(q.selection[e]===t){q.selection.splice(e,1);break}t.id==q.next_id-1?q.next_id--:q.free_ids.push(t.id),h.delete(t),s=!0}return!!s&&(w(),l(0<q.selection.length),h.setInfo(q.selection),h.updateLineHeight(q.arr.length),!0)},parse:s,stringify:function(){var e="[";return $("#phasor_list").children().each(function(s){let t=$(this),a=C.get(t.data("id"));if("undefined"!=typeof a){let l=JSON.stringify(t.find("input.phasor_exp").val());0<s&&(e+=","),e+="{ \"id\" : "+a.id+", \"parent\" : "+(a.parent?a.parent.id:-1)+",  \"value\" : "+l+", \"width\" : "+a.width+", \"skin\" : "+a.skin+", \"arrow\" : "+a.arrow+", \"arrow_size\" : "+a.arrow_size+", \"visible\" : "+a.visible+", \"label\" : "+JSON.stringify(a.label)+", \"color_index\" : "+a.color_index+", \"outline_width\" : "+a.outline_width+", \"outline_color\" : "+JSON.stringify(a.outline_color)+", \"symbol\" : "+JSON.stringify(a.symbol)+"}",s++}}),e+="]",e},load:function(e){let t=[],a=-1;try{for(let s=0;s<e.length;s++){if(g.checkInt(e[s].id,0,9999),g.checkInt(e[s].color_index,-1,d.phasor_colors.length-1),g.checkString(e[s].label,d.max_label_length),g.checkString(e[s].value,256),g.checkInt(e[s].width,1,d.max_phasor_width),g.checkInt(e[s].arrow,0,d.arrow_types.length-1),g.checkInt(e[s].arrow_size,d.arrow_size.min,d.arrow_size.max),g.checkInt(e[s].skin,0,d.phasor_skins.length),g.checkBool(e[s].visible),g.checkInt(e[s].outline_width,0,d.max_outline_width),g.checkString(e[s].symbol,64),0<e[s].symbol.length&&(!e[s].symbol.match(d.symbol_regex)||N.includes(e[s].symbol)))throw new Error("invalid symbol");if(g.checkInt(e[s].parent,-1,9999),e[s].parent===e[s].id)throw new Error("invalid parent");if(t.push(new m(e[s].id,1,1,e[s].color_index,e[s].label)),t[s].width=e[s].width,t[s].arrow=e[s].arrow,t[s].arrow_size=e[s].arrow_size,t[s].skin=e[s].skin,t[s].visible=e[s].visible,t[s].outline_width=e[s].outline_width,t[s].symbol=e[s].symbol,!t[s].outline_color.set(e[s].outline_color))throw new Error("invalid outline color");e[s].id>a&&(a=e[s].id),e[s].parsed=!1}for(let s=0;s<e.length;s++){if(0<=e[s].parent){let a;for(a=0;a<t.length&&t[a].id!==e[s].parent;a++);if(a==t.length)throw new Error("parent not found");t[s].parent=t[e[s].parent]}if(0<t[s].symbol.length)for(let a=0;a<e.length;a++)if(a!==s&&t[s].symbol===t[a].symbol)throw new Error("two identical symbols")}for(let e,s=0;s<t.length;s++){for(e=t[s].parent;e;){if(e===t[s])throw new Error("invalid parent loop");e=e.parent}_(t[s])}}catch(e){return!1}C.clear(),h.clear(),q.arr=[],q.selection=[],q.scope={},q.color_usage.fill(0);for(let s=0;s<t.length;s++){C.set(t[s].id,t[s]),q.arr.push(t[s]),0<t[s].symbol.length&&(q.scope[t[s].symbol]=t[s].value),0<=t[s].color_index&&q.color_usage[t[s].color_index]++;let a=h.add(t[s]);a.find("input.phasor_exp").val(e[s].value),h.updatePhasor(t[s],h.en.u.label,a),h.updatePhasor(t[s],h.en.u.visible,a),h.updatePhasor(t[s],h.en.u.parent,a),h.updatePhasor(t[s],h.en.u.symbol,a),h.updatePhasor(t[s],h.en.u.skin,a)}q.next_id=a+1,q.label_index=q.next_id;for(let s=0;s<q.next_id;s++)"undefined"==typeof C.get(s)&&q.free_ids.push(s);h.updateLineHeight(q.arr.length),l(!1);let o=t.length,r=0;for(;r!=o;){r=o;for(let a=0;a<t.length;a++)!e[a].parsed&&(null==t[a].parent||t[a].parent.valid)&&(s(t[a],e[a].value),t[a].valid&&(e[a].parsed=!0,o--))}return w(),!0},reset:function(){C.clear(),q.arr=[],h.clear(),q.max_phasor_len=0;for(let e=0;e<q.color_usage.length;e++)q.color_usage[e]=0;q.free_ids=[],q.next_id=0,q.label_index=0,q.selection=[],q.scope={},e(1,1),h.setInfo([])},getByIndex:function(e){return q.arr[e]},count:function(){return q.arr.length},getMaxLength:function(){return q.max_phasor_len},setSelectionInfo:function(){h.setInfo(q.selection)},setSelected:function(e,s=!1){"string"==typeof e&&(e=+e);let t=null;for(let a=0;a<q.selection.length;a++)if(q.selection[a].id===e){t=q.selection[a];break}if(!t)t=C.get(e),"undefined"==typeof t?t=null:(h.setSelected(t,!0),q.selection.push(t));else if(s){h.setSelected(t,!1);for(let e=0;e<q.selection.length;e++)if(q.selection[e]===t){q.arr.splice(e,1);break}}return l(0<q.selection.length),t},clearSelection:function(){for(let e=0;e<q.selection.length;e++)h.setSelected(q.selection[e],!1);q.selection=[],l(!1)},setExcSelected:function(e){"string"==typeof e&&(e=parseInt(e,10));let s=C.get(e);if("undefined"!=typeof s){let e=!1;for(let t=0;t<q.selection.length;t++)q.selection[t]===s?e=!0:h.setSelected(q.selection[t],!1);return q.selection=[s],e||h.setSelected(s,!0),l(!0),s}return null},getSelection:function(){return q.selection.slice(0)},isSelected:function(e){for(let s=0;s<q.selection.length;s++)if(q.selection[s].id===e)return!0;return!1},getSelected:function(){return 1===q.selection.length?q.selection[0]:null},isSelectionEmpty:function(){return!(0<q.selection.length)},en:A}}(),h=function(){function e(e,t,a){var l=Math.max,o=Math.min;if(!a&&(a=$(document.getElementById("phasor_"+e.id)),!a))return!1;switch(t){case s.u.label:{let s=l(o(1,14/e.label.length),.6);a.find("span.phasor_label > span").html(e.label).css("font-size",s+"em");break}case s.u.symbol:{let s=l(o(1,7/e.symbol.length),.55);a.find("span.phasor_symbol > span").html(e.symbol).css("font-size",s+"em");break}case s.u.parent:{let s=a.find("span.phasor_parent > span");if(e.parent){let t=l(o(1,7/e.parent.symbol.length),.55);s.html(e.parent.symbol).css("font-size",t+"em")}else s.html("");break}case s.u.parentclass:{let s=a.find("span.phasor_parent");e.valid_parent?s.removeClass("phasor_parent_invalid"):s.addClass("phasor_parent_invalid");break}case s.u.expression:{e.valid_exp&&e.system!==d.system.none&&a.find("input.phasor_exp").val(e.coord_strings[e.system]);break}case s.u.expclass:{let s=a.find("input.phasor_exp");e.valid_exp?s.removeClass("phasor_exp_invalid"):s.addClass("phasor_exp_invalid");break}case s.u.visible:{a.find("div.phasor_visible >input").prop("checked",e.visible);break}case s.u.system:{a.find("span.phasor_system >span").html(d.system_labels[e.system]);break}case s.u.skin:{a.find(".input-group-text").removeClass(d.phasor_skins[e.skin].classname).addClass(d.phasor_skins[e.skin].classname);break}}return!0}const s={btn:{del:0,edit:1},u:{label:0,symbol:1,parent:2,parentclass:3,expression:4,expclass:5,visible:6,system:7,skin:8}};Object.freeze(s);var a=$("#phasor_list"),l=$("#phasor_info"),o=document.getElementById("phasor_list_template"),r={lineheight:-1};return{add:function(s){let t=document.importNode(o.content,!0);a[0].appendChild(t);let l=$(a[0].lastElementChild);return l.find(".input-group").addClass("phasor_h"+r.lineheight),e(s,h.en.u.label,l),e(s,h.en.u.expression,l),l.attr("data-id",s.id),l.attr("id","phasor_"+s.id),l.data("id",s.id),l},delete:function(e){a.find("#phasor_"+e.id).remove()},clear:function(){a.empty(),r.lineheight=-1},setSelected:function(e,s){let t=document.getElementById("svg_phasor_"+e.id),a=$(document.getElementById("phasor_"+e.id).firstElementChild.firstElementChild);s?(t&&(t.firstElementChild.setAttribute("filter","url(#svg_glow)"),e.system!==d.system.none&&t.lastElementChild.setAttribute("fill-opacity",.6),$(t).appendTo($("#svg_phasors"))),a.addClass("phasor_selected")):(t&&(t.firstElementChild.setAttribute("filter",""),e.system!==d.system.none&&t.lastElementChild.setAttribute("fill-opacity",0)),a.removeClass("phasor_selected"))},enableButton:function(e,t){e===s.btn.del?$("#btn_del").prop("disabled",!t):e===s.btn.edit?$("#btn_edit").prop("disabled",!t):void 0},updatePhasor:e,updateLineHeight:function(e){let s=4;for(let t=2;0<=t;t--)if(e>d.lineheight_steps[t]){s=3-t;break}if(s!==r.lineheight){let e=a.find(".input-group");e.removeClass("phasor_h"+r.lineheight),e.addClass("phasor_h"+s),r.lineheight=s}},setInfo:function(e){if(e instanceof m)e.valid?l.html(e.label+": "+e.coord_strings):l.html(e.label+" is invalid");else if(1===e.length)e[0].valid?l.html(e[0].label+": "+e[0].coord_strings[0]):l.html(e[0].label+" is invalid");else if(2===e.length&&e[0].valid&&e[1].valid){let a=e[0].value.re+e[1].value.re,o=e[0].value.im+e[1].value.im,r=Math.acos((e[0].value.re*e[1].value.re+e[0].value.im*e[1].value.im)/(e[0].length*e[1].length)),i=180*r/t;0>r&&(r=2*t+r),0>i&&(i=360+i),r=g.round(r),i=g.round(i),a=g.round(a),o=g.round(o);let n=e[0].label+" + "+e[1].label+" = ( "+a+" , "+o+" ) , angle: "+r+" rad / "+i+"&deg;";l.html(n)}else l.html("")},en:s}}();class u{constructor(){this.custom_units={use:!1,major:1,minor:.5},this.grid={show:!1,style:2,color:new i},this.compass={show:!0,style:1,color:new i,gradient:{enabled:!1,from:new i("rgba(0,0,0,0.7)"),to:new i("rgba(255,255,255,1)")}},this.labels={color:new i,xp:!0,xn:!0,yp:!0,yn:!0,angles:!0,textsize:11},this.axis={show:!1,ticks:!0,style:0,color:new i},this.legend={show:!0,colors:{text:new i,bg:new i("rgba(255,255,255,1)"),border:new i}},this.quadrants=0}static check(e){try{return g.checkInt(e.quadrants,0,4),g.checkObj(e.legend),g.checkBool(e.legend.show),g.checkObj(e.legend.colors),g.checkObj(e.legend.colors.text),g.checkObj(e.legend.colors.bg),g.checkObj(e.legend.colors.border),g.checkObj(e.axis),g.checkBool(e.axis.show),g.checkBool(e.axis.ticks),g.checkInt(e.axis.style,0,d.stroke_styles.length-1),g.checkObj(e.axis.color),g.checkObj(e.labels),g.checkObj(e.labels.color),g.checkBool(e.labels.xn),g.checkBool(e.labels.xp),g.checkBool(e.labels.yn),g.checkBool(e.labels.yp),g.checkBool(e.labels.angles),g.checkInt(e.labels.textsize,d.text_size.min,d.text_size.max),g.checkObj(e.compass),g.checkBool(e.compass.show),g.checkInt(e.compass.style,0,d.stroke_styles.length-1),g.checkObj(e.compass.color),g.checkObj(e.compass.gradient),g.checkObj(e.compass.gradient.from),g.checkObj(e.compass.gradient.to),g.checkBool(e.compass.gradient.enabled),g.checkObj(e.grid),g.checkBool(e.grid.show),g.checkInt(e.grid.style,0,d.stroke_styles.length-1),g.checkObj(e.grid.color),g.checkObj(e.custom_units),g.checkBool(e.custom_units.use),g.checkNumber(e.custom_units.major),g.checkNumber(e.custom_units.minor),!0}catch(e){return!1}}load(e){this.quadrants=e.quadrants,this.legend.show=e.legend.show,this.legend.colors.bg.set(e.legend.colors.bg),this.legend.colors.text.set(e.legend.colors.text),this.legend.colors.border.set(e.legend.colors.border),this.axis.show=e.axis.show,this.axis.ticks=e.axis.ticks,this.axis.style=e.axis.style,this.axis.color.set(e.axis.color),this.labels.xn=e.labels.xn,this.labels.xp=e.labels.xp,this.labels.yn=e.labels.yn,this.labels.yp=e.labels.yp,this.labels.angles=e.labels.angles,this.labels.color.set(e.labels.color),this.labels.textsize=e.labels.textsize,this.compass.show=e.compass.show,this.compass.style=e.compass.style,this.compass.color.set(e.compass.color),this.compass.gradient.enabled=e.compass.gradient.enabled,this.compass.gradient.from.set(e.compass.gradient.from),this.compass.gradient.to.set(e.compass.gradient.to),this.grid.show=e.grid.show,this.grid.style=e.grid.style,this.grid.color.set(e.grid.color),this.custom_units.use=e.custom_units.use,this.custom_units.major=e.custom_units.major,this.custom_units.minor=e.custom_units.minor}reset(){this.quadrants=0,this.legend.show=!0,this.legend.colors.bg.set("rgba(255,255,255,1)"),this.legend.colors.text.set("#000000"),this.legend.colors.border.set("#000000"),this.axis.show=!1,this.axis.ticks=!0,this.axis.style=0,this.axis.color.set("#000000"),this.labels.xn=!0,this.labels.xp=!0,this.labels.yn=!0,this.labels.yp=!0,this.labels.angles=!0,this.labels.color.set("#000000"),this.labels.textsize=11,this.compass.show=!0,this.compass.style=1,this.compass.color.set("#000000"),this.compass.gradient.enabled=!1,this.compass.gradient.from.set("rgba(0,0,0,0.7)"),this.compass.gradient.to.set("rgba(255,255,255,1)"),this.grid.show=!1,this.grid.style=2,this.grid.color.set("#000000"),this.custom_units.use=!1,this.custom_units.major=1,this.custom_units.minor=1.5}}var b=new u,v=function(e){return{text:function(t){var s=document.createElementNS(d.svg.ns,"text");return"object"==typeof t?(s.setAttribute("x",t.x),s.setAttribute("y",t.y),s.textContent=t.label,s.setAttribute("font-size",t.size),0<t.length&&s.setAttribute("textLength",t.length)):"string"==typeof t&&(s.textContent=t),e.append(s),{pos:function(e,t){return s.setAttribute("x",e),s.setAttribute("y",t),this},length:function(e){return s.setAttribute("textLength",e),this},size:function(e){return s.setAttribute("font-size",e),this},color:function(e){return s.setAttribute("fill",e.hex),s.setAttribute("opacity",e.a),this},class:function(e){return s.setAttribute("class",e),this},adjustGlyphs:function(){return s.setAttribute("lengthAdjust","spacingAndGlyphs"),this},get:function(){return s}}},line:function(s,t,a,l){var o=document.createElementNS(d.svg.ns,"line");return o.setAttribute("vector-effect","non-scaling-stroke"),"object"==typeof s?(o.setAttribute("x1",s.from.x),o.setAttribute("y1",s.from.y),o.setAttribute("x2",s.to.x),o.setAttribute("y2",s.to.y)):(o.setAttribute("x1",s),o.setAttribute("y1",t),o.setAttribute("x2",a),o.setAttribute("y2",l)),e.append(o),{color:function(e){return o.setAttribute("stroke",e.hex),o.setAttribute("opacity",e.a),this},stroke:function(e){return o.setAttribute("stroke-width",e),this},dash:function(e){return o.setAttribute("stroke-dasharray",e),this},class:function(e){return o.setAttribute("class",e),this},get:function(){return o}}},circle:function(t,a,l,o=0){var r;if(0>=o||4<o)r=document.createElementNS(d.svg.ns,"circle"),r.setAttribute("cx",t),r.setAttribute("cy",a),r.setAttribute("r",l);else{r=document.createElementNS(d.svg.ns,"path");let e;1===o?e="M "+t+" "+(a-l)+" A "+l+" "+l+" 0 0 1 "+(t+l)+" "+a:2===o?e="M "+(t-l)+" "+a+" A "+l+" "+l+" 0 0 1 "+t+" "+(a-l):3===o?e="M "+(t-l)+" "+a+" A "+l+" "+l+" 0 0 0 "+t+" "+(a+l):4===o?e="M "+t+" "+(a+l)+" A "+l+" "+l+" 0 0 0 "+(t+l)+" "+a:void 0,r.setAttribute("d",e)}return r.setAttribute("vector-effect","non-scaling-stroke"),r.setAttribute("fill","none"),e.append(r),{color:function(e){return r.setAttribute("stroke",e.hex),r.setAttribute("stroke-opacity",e.a),this},fill:function(e){return"string"==typeof e?r.setAttribute("fill",e):(r.setAttribute("fill",e.hex),r.setAttribute("fill-opacity",e.a)),this},stroke:function(e){return r.setAttribute("stroke-width",e),this},dash:function(e){return r.setAttribute("stroke-dasharray",e),this},class:function(e){return r.setAttribute("class",e),this},get:function(){return r}}},rect:function(s,t,a,l){var o=document.createElementNS(d.svg.ns,"rect");return o.setAttribute("vector-effect","non-scaling-stroke"),o.setAttribute("fill","none"),"object"==typeof s?(o.setAttribute("x",s.x),o.setAttribute("y",s.y),o.setAttribute("width",s.width),o.setAttribute("height",s.height)):(o.setAttribute("x",s),o.setAttribute("y",t),o.setAttribute("width",a),o.setAttribute("height",l)),e.append(o),{color:function(e){return o.setAttribute("stroke",e.hex),o.setAttribute("stroke-opacity",e.a),this},fill:function(e){return o.setAttribute("fill",e.hex),o.setAttribute("fill-opacity",e.a),this},stroke:function(e){return o.setAttribute("stroke-width",e),this},rounded:function(e){return o.setAttribute("rx",e),o.setAttribute("ry",e),this},dash:function(e){return o.setAttribute("stroke-dasharray",e),this},class:function(e){return o.setAttribute("class",e),this},get:function(){return o}}},path:function(s){var t=document.createElementNS(d.svg.ns,"path");return t.setAttribute("d",s),t.setAttribute("vector-effect","non-scaling-stroke"),t.setAttribute("fill","none"),e.append(t),{color:function(e){return t.setAttribute("stroke",e.hex),t.setAttribute("stroke-opacity",e.a),this},fill:function(e){return t.setAttribute("fill",e.hex),t.setAttribute("fill-opacity",e.a),this},stroke:function(e){return t.setAttribute("stroke-width",e),this},dash:function(e){return t.setAttribute("stroke-dasharray",e),this},class:function(e){return t.setAttribute("class",e),this},get:function(){return t}}}}},f=function(){function e(){var e=Math.floor,s=Math.abs,t=Math.ceil;let a=_.getMaxLength();if(b.custom_units.use)m.circle_unit=b.custom_units.major,m.ticks_unit=b.custom_units.minor;else{let e=0<b.quadrants?6:4;if(1<a&&1e3>=a){let l=0,o=1e3;for(let r,n=0;n<u.circle_arr.length;n++)r=s(t(a/u.circle_arr[n])-e),r<o&&(l=n,o=r);m.circle_unit=u.circle_arr[l],m.ticks_unit=u.ticks_arr[l]}else{let s=a/e,t=""+s,r=0;if(1<s){for(;r<t.length&&"."!=t[r];r++);1<r?(s=o(s/l(10,r-1)),s=2>s?1:6>s?5:10,m.circle_unit=s*l(10,r-1)):2>s?m.circle_unit=1:6>s?m.circle_unit=5:m.circle_unit=10,m.ticks_unit=.5*m.circle_unit}else{for(;r<t.length&&("0"==t[r]||"."==t[r]);r++);s=o(l(10,r-1)*s),s=2>s?1:6>s?5:10,m.circle_unit=s/l(10,r-1),m.ticks_unit=.5*m.circle_unit}}}if(m.number_of_circles=e(a/m.circle_unit)+1,m.scale=d.viewbox_base/(m.number_of_circles*m.circle_unit),m.circle_unit_scaled=m.circle_unit*m.scale,m.ticks_unit_scaled=m.ticks_unit*m.scale,m.max_circle=m.number_of_circles*m.circle_unit_scaled,m.cos30r=.86602540378*m.max_circle,m.sin30r=.5*m.max_circle,0<b.quadrants){m.textsize=.5*(.055*d.viewbox_base*b.labels.textsize*d.text_size.factor),m.max=d.viewbox_base+2.5*m.textsize,m.arrow_width=.0025*d.viewbox_base;for(let e=1;e<d.arrow_types.length;e++)m.arrows[e].length=.7*(d.arrow_types[e].length*d.viewbox_base);p.find("#svg_glow feMorphology").attr("radius",.005*d.viewbox_base)}else{m.textsize=.055*d.viewbox_base*b.labels.textsize*d.text_size.factor,m.max=d.viewbox_base+2.5*m.textsize,m.arrow_width=.004*d.viewbox_base;for(let e=1;e<d.arrow_types.length;e++)m.arrows[e].length=d.arrow_types[e].length*d.viewbox_base;p.find("#svg_glow feMorphology").attr("radius",.01*d.viewbox_base)}window.matchMedia("(max-width: 500px)").matches?(m.phasor_circle_radius=.1*d.viewbox_base,m.legend_circle_factor=1.5):window.matchMedia("(max-width: 700px)").matches?(m.phasor_circle_radius=.09*d.viewbox_base,m.legend_circle_factor=1):(m.phasor_circle_radius=.04*d.viewbox_base,m.legend_circle_factor=.5),h.radius_squard=m.phasor_circle_radius*m.phasor_circle_radius,1==b.quadrants?(m.viewbox.x=1.8*-m.textsize,m.viewbox.y=-m.max+.7*m.textsize,m.viewbox.width=m.max+m.textsize):2==b.quadrants?(m.viewbox.x=-1*m.max,m.viewbox.y=-m.max+.4*m.textsize,m.viewbox.width=m.max+1.8*m.textsize):3==b.quadrants?(m.viewbox.x=-1*m.max,m.viewbox.y=-2.6*m.textsize,m.viewbox.width=m.max+2.5*m.textsize):4==b.quadrants?(m.viewbox.x=-2.5*m.textsize,m.viewbox.y=-2.3*m.textsize,m.viewbox.width=m.max+2*m.textsize):(m.viewbox.x=-1*m.max,m.viewbox.y=m.viewbox.x,m.viewbox.width=2*m.max),m.viewbox.height=m.viewbox.width,m.viewbox.string=""+m.viewbox.x+","+m.viewbox.y+","+m.viewbox.width+","+m.viewbox.height}function s(e){let s=document.createElementNS(d.svg.ns,"g");h.points=[];for(let t,l=0;l<_.count();l++)if(t=_.getByIndex(l),t.valid&&t.visible&&(t.sx!=t.fx||t.sy!=t.fy)){let e,l,o,r,i,n,c,g,p,u,b,x,f,y=t.sx*m.scale,w=t.sy*m.scale,k=t.fx*m.scale,z=t.fy*m.scale,S=t.value.re*m.scale,A=t.value.im*m.scale,C=m.arrow_width*t.width,q=.5*C,N=a(S*S+A*A),E=m.arrows[t.arrow].length*(t.arrow_size*d.arrow_size.factor),V=S/N,j=A/N;if(e=y+j*q,l=w-V*q,o=y-j*q,r=w+V*q,0==m.arrows[t.arrow].length)i=k+j*q,n=z-V*q,c=k-j*q,g=z+V*q,f="M "+e+","+-l+" L "+i+","+-n+" L "+c+","+-g+" L "+o+","+-r+" z";else{let s=-V*m.arrows[t.arrow].cos+j*m.arrows[t.arrow].sin,a=-j*m.arrows[t.arrow].cos-V*m.arrows[t.arrow].sin,_=-V*m.arrows[t.arrow].cos-j*m.arrows[t.arrow].sin,h=-j*m.arrows[t.arrow].cos+V*m.arrows[t.arrow].sin,v=N-m.arrows[t.arrow].cos*E,y=V*v,w=j*v;if(i=e+y,n=l+w,c=o+y,g=r+w,p=k+E*s,u=z+E*a,b=k+E*_,x=z+E*h,d.arrow_types[t.arrow].filled)f="M "+e+","+-l+" L "+i+","+-n+" L "+p+","+-u+" L "+k+","+-z+" L "+b+","+-x+" L "+c+","+-g+" L "+o+","+-r+" z";else{let i,n,d,c,g,S,A,E,I=(C/m.arrows[t.arrow].cos+q)/m.arrows[t.arrow].tan,O=(N-v-I)/m.arrows[t.arrow].cos+m.arrows[t.arrow].tan*C;v=N-I,y=V*v,w=j*v,i=e+y,n=l+w,d=o+y,c=r+w,g=i+O*s,S=n+O*a,A=d+O*_,E=c+O*h,f="M "+e+","+-l+" L "+i+","+-n+" L "+g+","+-S+" L "+p+","+-u+" L "+k+","+-z+" L "+b+","+-x+" L "+A+","+-E+" L "+d+","+-c+" L "+o+","+-r+" z"}}let I=document.createElementNS(d.svg.ns,"g");v(I).path(f).color(t.outline_color).fill(t.color).stroke(t.outline_width),t.system!==d.system.none&&(h.points.push({x:k,y:-1*z,id:t.id}),v(I).line(y,-1*w,k,-1*z).color(t.color).stroke(2).class("hidden"),v(I).circle(k,-1*z,m.phasor_circle_radius).stroke(1).color(d.colors.invisible).fill(d.colors.invisible)),I.setAttribute("id","svg_phasor_"+t.id),_.isSelected(t.id)&&(I.firstElementChild.setAttribute("filter","url(#svg_glow)"),t.system!==d.system.none&&I.lastElementChild.setAttribute("fill-opacity",.6)),s.append(I)}s.setAttribute("id","svg_phasors"),e.append(s)}function t(e){if(b.axis.show){let s=document.createElementNS(d.svg.ns,"g"),t=d.stroke_styles[b.axis.style].value;switch(b.quadrants){case 0:v(s).line(-1*m.max_circle,0,m.max_circle,0).color(b.axis.color).stroke(1).dash(t),v(s).line(0,m.max_circle,0,-1*m.max_circle).color(b.axis.color).stroke(1).dash(t);break;case 1:v(s).line(0,0,m.max_circle,0).color(b.axis.color).stroke(1).dash(t),v(s).line(0,0,0,-1*m.max_circle).color(b.axis.color).stroke(1).dash(t);break;case 2:v(s).line(-1*m.max_circle,0,0,0).color(b.axis.color).stroke(1).dash(t),v(s).line(0,0,0,-1*m.max_circle).color(b.axis.color).stroke(1).dash(t);break;case 3:v(s).line(-1*m.max_circle,0,0,0).color(b.axis.color).stroke(1).dash(t),v(s).line(0,m.max_circle,0,0).color(b.axis.color).stroke(1).dash(t);break;case 4:v(s).line(0,0,m.max_circle,0).color(b.axis.color).stroke(1).dash(t),v(s).line(0,m.max_circle,0,0).color(b.axis.color).stroke(1).dash(t);}if(b.axis.ticks){let e,t,a=m.max_circle*d.tick_length,l=o(m.circle_unit/m.ticks_unit),r=1,i=m.ticks_unit_scaled;for(;i<=m.max_circle;){switch(0==r%l?(e=1.6*a,t=2):(e=a,t=1),b.quadrants){case 0:{v(s).line(i,-1*e,i,e).color(b.axis.color).stroke(t),v(s).line(-1*i,-1*e,-1*i,e).color(b.axis.color).stroke(t),v(s).line(-1*e,i,e,i).color(b.axis.color).stroke(t),v(s).line(-1*e,-1*i,e,-1*i).color(b.axis.color).stroke(t);break}case 1:{v(s).line(i,-1*e,i,e).color(b.axis.color).stroke(t),v(s).line(-1*e,-1*i,e,-1*i).color(b.axis.color).stroke(t);break}case 2:{v(s).line(-1*i,-1*e,-1*i,e).color(b.axis.color).stroke(t),v(s).line(-1*e,-1*i,e,-1*i).color(b.axis.color).stroke(t);break}case 3:{v(s).line(-1*i,-1*e,-1*i,e).color(b.axis.color).stroke(t),v(s).line(-1*e,i,e,i).color(b.axis.color).stroke(t);break}case 4:{v(s).line(i,-1*e,i,e).color(b.axis.color).stroke(t),v(s).line(-1*e,i,e,i).color(b.axis.color).stroke(t);break}}i+=m.ticks_unit_scaled,r++}}s.setAttribute("id","svg_axis"),e.append(s)}}function r(e){if(b.grid.show){let s=document.createElementNS(d.svg.ns,"g"),t=d.stroke_styles[b.grid.style].value;if(!b.axis.show)switch(b.quadrants){case 0:v(s).line(0,m.max_circle,0,-1*m.max_circle).color(b.grid.color).stroke(1).dash(t),v(s).line(m.max_circle,0,-1*m.max_circle,0).color(b.grid.color).stroke(1).dash(t);break;case 1:v(s).line(0,0,0,-1*m.max_circle).color(b.grid.color).stroke(1).dash(t),v(s).line(m.max_circle,0,0,0).color(b.grid.color).stroke(1).dash(t);break;case 2:v(s).line(0,0,0,-1*m.max_circle).color(b.grid.color).stroke(1).dash(t),v(s).line(0,0,-1*m.max_circle,0).color(b.grid.color).stroke(1).dash(t);break;case 3:v(s).line(0,m.max_circle,0,0).color(b.grid.color).stroke(1).dash(t),v(s).line(0,0,-1*m.max_circle,0).color(b.grid.color).stroke(1).dash(t);break;case 4:v(s).line(0,m.max_circle,0,0).color(b.grid.color).stroke(1).dash(t),v(s).line(m.max_circle,0,0,0).color(b.grid.color).stroke(1).dash(t);}switch(b.quadrants){case 0:{for(let e=0,a=m.max_circle;e<m.number_of_circles;e++,a-=m.circle_unit_scaled)v(s).line(a,m.max_circle,a,-1*m.max_circle).color(b.grid.color).stroke(1).dash(t),v(s).line(m.max_circle,a,-1*m.max_circle,a).color(b.grid.color).stroke(1).dash(t),v(s).line(-1*a,m.max_circle,-1*a,-1*m.max_circle).color(b.grid.color).stroke(1).dash(t),v(s).line(m.max_circle,-1*a,-1*m.max_circle,-1*a).color(b.grid.color).stroke(1).dash(t);break}case 1:{for(let e=0,a=m.max_circle;e<m.number_of_circles;e++,a-=m.circle_unit_scaled)v(s).line(a,0,a,-1*m.max_circle).color(b.grid.color).stroke(1).dash(t),v(s).line(m.max_circle,-1*a,0,-1*a).color(b.grid.color).stroke(1).dash(t);break}case 2:{for(let e=0,a=m.max_circle;e<m.number_of_circles;e++,a-=m.circle_unit_scaled)v(s).line(-1*a,0,-1*a,-1*m.max_circle).color(b.grid.color).stroke(1).dash(t),v(s).line(0,-1*a,-1*m.max_circle,-1*a).color(b.grid.color).stroke(1).dash(t);break}case 3:{for(let e=0,a=m.max_circle;e<m.number_of_circles;e++,a-=m.circle_unit_scaled)v(s).line(0,a,-1*m.max_circle,a).color(b.grid.color).stroke(1).dash(t),v(s).line(-1*a,m.max_circle,-1*a,0).color(b.grid.color).stroke(1).dash(t);break}case 4:{for(let e=0,a=m.max_circle;e<m.number_of_circles;e++,a-=m.circle_unit_scaled)v(s).line(a,m.max_circle,a,0).color(b.grid.color).stroke(1).dash(t),v(s).line(m.max_circle,a,0,a).color(b.grid.color).stroke(1).dash(t);break}}s.setAttribute("id","svg_cartgrid"),e.append(s)}}function i(e){if(b.compass.show){let s=d.stroke_styles[b.compass.style].value,t=document.createElementNS(d.svg.ns,"g"),a=m.max_circle;for(let e=0;e<m.number_of_circles;e++)b.compass.gradient.enabled&&0==e&&0==b.quadrants?v(t).circle(0,0,a,b.quadrants).stroke(1).color(b.compass.color).dash(s).fill("url(#svg_compassgrad)"):v(t).circle(0,0,a,b.quadrants).stroke(1).color(b.compass.color).dash(s),a-=m.circle_unit_scaled;switch(b.quadrants){case 0:{b.axis.show||(v(t).line(-1*m.max_circle,0,m.max_circle,0).color(b.compass.color).stroke(1).dash(s),v(t).line(0,m.max_circle,0,-1*m.max_circle).color(b.compass.color).stroke(1).dash(s)),v(t).line(-1*m.sin30r,m.cos30r,m.sin30r,-1*m.cos30r).color(b.compass.color).stroke(1).dash(s),v(t).line(-1*m.sin30r,-1*m.cos30r,m.sin30r,m.cos30r).color(b.compass.color).stroke(1).dash(s),v(t).line(-1*m.cos30r,m.sin30r,m.cos30r,-1*m.sin30r).color(b.compass.color).stroke(1).dash(s),v(t).line(-1*m.cos30r,-1*m.sin30r,m.cos30r,m.sin30r).color(b.compass.color).stroke(1).dash(s);break}case 1:{b.axis.show||(v(t).line(0,0,m.max_circle,0).color(b.compass.color).stroke(1).dash(s),v(t).line(0,0,0,-1*m.max_circle).color(b.compass.color).stroke(1).dash(s)),v(t).line(0,0,m.sin30r,-1*m.cos30r).color(b.compass.color).stroke(1).dash(s),v(t).line(0,0,m.cos30r,-1*m.sin30r).color(b.compass.color).stroke(1).dash(s);break}case 2:{b.axis.show||(v(t).line(-1*m.max_circle,0,0,0).color(b.compass.color).stroke(1).dash(s),v(t).line(0,0,0,-1*m.max_circle).color(b.compass.color).stroke(1).dash(s)),v(t).line(-1*m.sin30r,-1*m.cos30r,0,0).color(b.compass.color).stroke(1).dash(s),v(t).line(-1*m.cos30r,-1*m.sin30r,0,0).color(b.compass.color).stroke(1).dash(s);break}case 3:{b.axis.show||(v(t).line(-1*m.max_circle,0,0,0).color(b.compass.color).stroke(1).dash(s),v(t).line(0,m.max_circle,0,0).color(b.compass.color).stroke(1).dash(s)),v(t).line(-1*m.sin30r,m.cos30r,0,0).color(b.compass.color).stroke(1).dash(s),v(t).line(-1*m.cos30r,m.sin30r,0,0).color(b.compass.color).stroke(1).dash(s);break}case 4:{b.axis.show||(v(t).line(0,0,m.max_circle,0).color(b.compass.color).stroke(1).dash(s),v(t).line(0,m.max_circle,0,0).color(b.compass.color).stroke(1).dash(s)),v(t).line(0,0,m.sin30r,m.cos30r).color(b.compass.color).stroke(1).dash(s),v(t).line(0,0,m.cos30r,m.sin30r).color(b.compass.color).stroke(1).dash(s);break}}t.setAttribute("id","svg_compass"),e.append(t);let l=p.find("#svg_compassgrad stop");l.eq(0).attr("stop-color",b.compass.gradient.from.hex),l.eq(1).attr("stop-color",b.compass.gradient.to.hex),l.eq(0).attr("stop-opacity",b.compass.gradient.from.a),l.eq(1).attr("stop-opacity",b.compass.gradient.to.a)}}function n(e){if(b.labels.xp||b.labels.yp||b.labels.xn||b.labels.yn||b.labels.angles){let t=document.createElementNS(d.svg.ns,"g");if(b.labels.angles){u.angles[0].x=m.max_circle+.2*m.textsize,u.angles[0].y=.35*m.textsize,u.angles[1].x=m.sin30r+.15*m.textsize,u.angles[1].y=-1*m.cos30r,u.angles[2].x=m.cos30r,u.angles[2].y=-1*m.sin30r-.15*m.textsize,u.angles[3].x=-.5*m.textsize,u.angles[3].y=-1*m.max_circle-.2*m.textsize,u.angles[4].x=-1*m.cos30r-1.4*m.textsize,u.angles[4].y=-1*m.sin30r-.25*m.textsize,u.angles[5].x=-1*m.sin30r-2.1*m.textsize,u.angles[5].y=-1*m.cos30r-.05*m.textsize,u.angles[6].x=-1*m.max_circle-2.4*m.textsize,u.angles[6].y=.3*m.textsize,u.angles[7].x=-1*m.sin30r-2.2*m.textsize,u.angles[7].y=m.cos30r+.9*m.textsize,u.angles[8].x=-1*m.cos30r-1.8*m.textsize,u.angles[8].y=m.sin30r+1.05*m.textsize,u.angles[9].x=-1*m.textsize,u.angles[9].y=m.max_circle+m.textsize,u.angles[10].x=m.cos30r-.3*m.textsize,u.angles[10].y=m.sin30r+m.textsize,u.angles[11].x=m.sin30r+.15*m.textsize,u.angles[11].y=m.cos30r+.6*m.textsize;for(let e=u.angle_indices[b.quadrants].from;e<=u.angle_indices[b.quadrants].to;e++)v(t).text(u.angles[e].s).pos(u.angles[e].x,u.angles[e].y).size(m.textsize).color(b.labels.color).class("angle noselect");4==b.quadrants&&v(t).text(u.angles[0].s).pos(u.angles[0].x,u.angles[0].y).size(m.textsize).color(b.labels.color).class("angle noselect")}let a,r,i,n=!1,c=m.textsize*(1-.015*m.number_of_circles),g=0,p=m.circle_unit,_=m.circle_unit_scaled,h=.001>=m.circle_unit||1e4<=m.circle_unit;if(1>m.circle_unit){let e=m.circle_unit.toString().length-2;a=l(10,e),n=!0}for(let e=0;e<m.number_of_circles;e++,_+=m.circle_unit_scaled,p+=m.circle_unit){n&&(p=o(p*a)/a);let e=h?p.toExponential():p.toString();g=.5*e.length*c,b.labels.xp&&2!=b.quadrants&&3!=b.quadrants&&(4===b.quadrants?(r=_-1.2*g,i=-.6*c):(r=_-1.2*g,i=1.05*c),v(t).text(e).pos(r,i).size(c).color(b.labels.color).class("unit noselect")),b.labels.yp&&3!=b.quadrants&&4!=b.quadrants&&(1===b.quadrants?(r=-1*g-.2*m.textsize,i=-1*_+1.2*c):(r=.1*g,i=-1*_+1.2*c),v(t).text(e).pos(r,i).size(c).color(b.labels.color).class("unit noselect")),e="-"+e,g=.5*e.length*c,b.labels.xn&&1!=b.quadrants&&4!=b.quadrants&&(3===b.quadrants?(r=-1*_+.1*g,i=-.7*c):(r=-1*_+.1*g,i=1.05*c),v(t).text(e).pos(r,i).size(c).color(b.labels.color).class("unit noselect")),b.labels.yn&&1!=b.quadrants&&2!=b.quadrants&&(4===b.quadrants?(r=-1*g-.2*m.textsize,i=_-.3*c):(r=.1*g,i=_-.3*c),v(t).text(e).pos(r,i).size(c).color(b.labels.color).class("unit noselect"))}t.setAttribute("id","svg_unitlabels"),e.append(t)}}function c(){if(b.legend.show){let e=0,s=[];for(let t,a=0;a<_.count();a++)t=_.getByIndex(a),t.valid&&t.visible&&(t.sx!=t.fx||t.sy!=t.fy)&&(t.label.length>e&&(e=t.label.length),s.push(t));if(0<s.length){let t=0<b.quadrants?.03*(m.max*d.label_size):.042*(m.max*d.label_size);let a=.45*t;e=0==e?t+3*a:6*a+.5*(e*t);let l=t*s.length+a*(s.length+1),o=document.createElementNS(d.svg.ns,"g");v(o).rect(0,0,e,l).stroke(1).color(b.legend.colors.border).fill(b.legend.colors.bg).rounded(0<b.quadrants?20:30);for(let e=0;e<s.length;e++)v(o).rect(1.5*a,a*(e+1)+t*e,t,t).stroke(1).color(s[e].color).fill(s[e].color),v(o).text(s[e].label).pos(2.5*a+t,a*(e+1)+t*(e+1)-.1*t).size(t).color(b.legend.colors.text).class("legend noselect");v(o).circle(e,l,t*m.legend_circle_factor).stroke(2).color(d.colors.legend_scale_circle).fill(d.colors.legend_scale_circle).class("invisible").get();let r,i;switch(b.quadrants){case 0:case 1:r=m.max_circle-e,i=m.max_circle;break;case 2:r=-1*e,i=m.max_circle;break;case 3:r=-1*e,i=0;break;case 4:r=m.max_circle-e,i=0;}o.setAttribute("transform","matrix(1 0 0 1 "+r+" -"+i+")"),o.setAttribute("class","svg_legend"),o.setAttribute("id","svg_legend"),p.append(o)}}}var p=$("#svg"),m={scale:0,number_of_circles:0,circle_unit:0,ticks_unit:0,circle_unit_scaled:0,ticks_unit_scaled:0,max:0,max_circle:0,textsize:0,cos30r:0,sin30r:0,arrows:[],phasor_circle_radius:0,legend_circle_factor:0,viewbox:{x:0,y:0,width:0,height:0,string:""}},h={radius_squard:0,points:[]},u={circle_arr:[.1,.5,1,5,10,25,50,100,250],ticks_arr:[.05,.1,.5,1,5,5,10,25,50],angles:[{s:"0\xB0",x:0,y:0},{s:"30\xB0",x:0,y:0},{s:"60\xB0",x:0,y:0},{s:"90\xB0",x:0,y:0},{s:"120\xB0",x:0,y:0},{s:"150\xB0",x:0,y:0},{s:"180\xB0",x:0,y:0},{s:"210\xB0",x:0,y:0},{s:"240\xB0",x:0,y:0},{s:"270\xB0",x:0,y:0},{s:"300\xB0",x:0,y:0},{s:"330\xB0",x:0,y:0}],angle_indices:[{from:0,to:11},{from:0,to:3},{from:3,to:6},{from:6,to:9},{from:9,to:11}]};return function(){var e=Math.tan,s=Math.cos,t=Math.sin;for(let a=0;a<d.arrow_types.length;a++)m.arrows.push({length:0,sin:t(d.arrow_types[a].angle),cos:s(d.arrow_types[a].angle),tan:e(d.arrow_types[a].angle)})}(),{update:function(){e(),p.attr("viewBox",m.viewbox.string),p.find("defs").nextAll().remove();let a=document.createElementNS(d.svg.ns,"g");r(a),t(a),i(a),n(a),s(a),a.setAttribute("id","svg_main"),a.setAttribute("transform","matrix(1 0 0 1 0 0)"),p.append(a),c()},getScale:function(){return m.scale},phasordrag:h}}(),y=function(){function e(e,s){let t=document.getElementById("svg").cloneNode(!0),a=$(t);"undefined"!=typeof e&&"undefined"!=typeof s&&(a.attr("width",e),a.attr("height",s)),a.find("#svg_phasors g").removeAttr("filter"),a.find("#svg_legend circle, defs filter, #svg_phasors line, #svg_phasors circle").remove();let l=document.implementation.createDocumentType("svg",d.svg.publicid,d.svg.systemId),o=document.implementation.createDocument(d.svg.ns,"svg",l);return o.replaceChild(t,o.documentElement),new XMLSerializer().serializeToString(o)}var s=document.createElement("canvas");return{savePNG:function(t,a,l,o){s.width=a,s.height=l;var r=s.getContext("2d");r.fillStyle=o,r.fillRect(0,0,a,l);var i=self.URL||self.webkitURL||self,n=new Blob([e(a,l)],{type:"image/svg+xml;charset=utf-8"}),c=i.createObjectURL(n);let g=new Image;g.onload=function(){r.drawImage(this,0,0),i.revokeObjectURL(c),d.appmode?APP.saveFile(t,s.toDataURL("image/png")):saveAs(s.toDataURL("image/png"),t)},g.src=c},saveSVG:function(s,t,a){if(d.appmode)APP.saveFile(s,e(t,a));else{let l=new Blob([e(t,a)],{type:"image/svg+xml"});saveAs(l,s)}},saveJSON:function(e){let s="{ \"settings\" : "+JSON.stringify(b)+", \"phasors\" : "+_.stringify()+"}";if(d.appmode)APP.saveFile(e,s);else{let t=new Blob([s],{type:"application/json"});saveAs(t,e)}},load:function(e,s){var t=new FileReader;t.onload=function(t){try{let e=JSON.parse(t.target.result);u.check(e.settings)&&_.load(e.phasors)?(b.load(e.settings),s({success:!0,msg:""})):s({success:!1,msg:"failed to parse phasorviz data."})}catch(e){s({success:!1,msg:"failed to parse JSON."})}},t.onerror=function(t){s({success:!1,msg:"Failed to read file. (Errorcode: "+t.target.error.code+")"})},t.readAsText(e)},loadString:function(e,s){try{let t=JSON.parse(e);u.check(t.settings)&&_.load(t.phasors)?b.load(t.settings):d.appmode?APP.showToast("Invalid file"):s({success:!1,msg:"Invalid file"})}catch(e){d.appmode?APP.showToast("Failed to parse json"):s({success:!1,msg:"Failed to parse json"})}}}}(),w=function(){function e(s){P===B.edit?$(s.target).find("button.btn-primary").focus():P===B.settings?$(s.target).find("button.btn-primary").focus():P===B.delete?$(s.target).find("button.btn-danger").focus():P===B.load?$(s.target).find("button.btn-primary").focus():P===B.save?$("#dlgsave_name").focus():P===B.info?$(s.target).find("button.btn-primary").focus():P===B.net?k():void 0}function s(){P===B.edit?$("#dlgedit").modal("hide"):P===B.settings?($("#dlgs_cu_ticks").removeClass("invalid_input"),$("#dlgs_cu_main").removeClass("invalid_input"),$("#dlgsettings").modal("hide")):P===B.delete?$("#dlgdel").modal("hide"):P===B.load?$("#dlgload").modal("hide"):P===B.save?$("#dlgsave").modal("hide"):P===B.info?$("#dlginfo").modal("hide"):P===B.net?$("#dlgnet").modal("hide"):void 0;P=B.none}function t(){switch(P){case B.edit:{r(),L(T.main,T.legend),P=B.none,$("#dlgedit").modal("hide");break}case B.settings:{p()&&(L(T.main,T.legend),P=B.none,$("#dlgsettings").modal("hide"));break}case B.delete:{_.delete(_.getSelection()),L(!1,!1),P=B.none,$("#dlgdel").modal("hide");break}case B.load:{v();break}case B.save:{q()&&(P=B.none,$("#dlgsave").modal("hide"));break}case B.info:{$("#dlginfo").modal("hide");break}case B.net:{let e=$("#dlgnet");"upload"==e.data("what")?e.modal("hide"):z();break}}}function a(){if(_.isSelectionEmpty())throw new Error("empty selection");let e,s,t,a,o,r,n,d,c=_.getSelection();for(s=t=a=o=r=n=d=!1,e=1;e<c.length;e++)s||c[e].color.equals(c[e-1].color)||(s=!0),t||c[e].outline_color.equals(c[e-1].outline_color)||(t=!0),o||c[e].width==c[e-1].width||(o=!0),a||c[e].outline_width==c[e-1].outline_width||(a=!0),r||c[e].arrow==c[e-1].arrow||(r=!0),n||c[e].arrow_size==c[e-1].arrow_size||(n=!0),d||c[e].skin==c[e-1].skin||(d=!0);l("dlgedit_color",s),l("dlgedit_color_ol",t),l("dlgedit_width",o),l("dlgedit_ol_width",a),l("dlgedit_arrow",r),l("dlgedit_arrowsize",n),l("dlgedit_skin",d);let g=$("#dlgedit_color > input");g.val(c[0].color.rgba),g.trigger("change"),g=$("#dlgedit_color_ol > input"),g.val(c[0].outline_color.rgba),g.trigger("change"),$("#dlgedit_ol_width option").eq(c[0].outline_width).prop("selected",!0),$("#dlgedit_width option").eq(c[0].width-1).prop("selected",!0),$("#dlgedit_arrow option").eq(c[0].arrow).prop("selected",!0),$("#dlgedit_arrowsize").val(c[0].arrow_size),$("#dlgedit_skin option").eq(c[0].skin).prop("selected",!0)}function l(e,s){let t=document.getElementById(e).parentElement.parentElement,a=t.children;$(t).data("overlay",s).data("overwrite",s),s?(a[0].style="display: block;",a[1].firstElementChild.style=""):(a[0].style="",a[1].firstElementChild.style="display: none;")}function o(s){let e=$(s.target).closest(".dlg_row");if(e.data("overwrite")){let s=e.find(".dlgedit_overlay");e.data("overlay")?(e.data("overlay",!1),s.css("display","none")):(e.data("overlay",!0),s.css("display","block"))}}function r(){let e=_.getSelection(),s=$("#dlgedit_color").closest(".dlg_row"),t=!s.data("overwrite")||!s.data("overlay");s=$("#dlgedit_color_ol").closest(".dlg_row");let a=!s.data("overwrite")||!s.data("overlay");s=$("#dlgedit_width").closest(".dlg_row");let l=!s.data("overwrite")||!s.data("overlay");s=$("#dlgedit_ol_width").closest(".dlg_row");let o=!s.data("overwrite")||!s.data("overlay");s=$("#dlgedit_arrow").closest(".dlg_row");let r=!s.data("overwrite")||!s.data("overlay");s=$("#dlgedit_arrowsize").closest(".dlg_row");let n=!s.data("overwrite")||!s.data("overlay");s=$("#dlgedit_skin").closest(".dlg_row");let d=!s.data("overwrite")||!s.data("overlay"),c=$("#dlgedit_color >").val(),g=$("#dlgedit_color_ol > input").val(),p=$("#dlgedit_width").prop("selectedIndex")+1,m=$("#dlgedit_ol_width").prop("selectedIndex"),h=$("#dlgedit_arrow").prop("selectedIndex"),u=+$("#dlgedit_arrowsize").val(),b=$("#dlgedit_skin").prop("selectedIndex");for(let s=0;s<e.length;s++)t&&_.set(e[s],_.en.color,c),a&&e[s].outline_color.set(g),l&&(e[s].width=p),o&&(e[s].outline_width=m),r&&(e[s].arrow=h),n&&(e[s].arrow_size=u),d&&e[s].skin!==b&&_.set(e[s],_.en.skin,b);T.main=!1,T.legend=!1}function i(){$("#dlgs_quadrants option").eq(b.quadrants).prop("selected",!0),$("#dlgs_compass").prop("checked",b.compass.show),$("#dlgs_compass_style option").eq(b.compass.style).prop("selected",!0),$("#dlgs_compass_color > input").val(b.compass.color.rgba).trigger("change");let e=$("#dlgs_compass_grad");e.prop("checked",b.compass.gradient.enabled),$("#dlgs_compass_grad_from > input").val(b.compass.gradient.from.rgba).trigger("change"),$("#dlgs_compass_grad_to > input").val(b.compass.gradient.to.rgba).trigger("change"),$("#dlgs_grid").prop("checked",b.grid.show),$("#dlgs_grid_style option").eq(b.grid.style).prop("selected",!0),$("#dlgs_grid_color > input").val(b.grid.color.rgba).trigger("change"),$("#dlgs_axis").prop("checked",b.axis.show),$("#dlgs_axis_style option").eq(b.axis.style).prop("selected",!0),$("#dlgs_axis_color > input").val(b.axis.color.rgba).trigger("change"),$("#dlgs_axis_ticks").prop("checked",b.axis.ticks),$("#dlgs_labels_xp").prop("checked",b.labels.xp),$("#dlgs_labels_xn").prop("checked",b.labels.xn),$("#dlgs_labels_yp").prop("checked",b.labels.yp),$("#dlgs_labels_yn").prop("checked",b.labels.yn),$("#dlgs_labels_angles").prop("checked",b.labels.angles),$("#dlgs_labels_color > input").val(b.labels.color.rgba).trigger("change"),$("#dlgs_labels_textsize").val(b.labels.textsize);let s=$("#dlgs_legend");s.prop("checked",b.legend.show),$("#dlgs_legend_c_text > input").val(b.legend.colors.text.rgba).trigger("change"),$("#dlgs_legend_c_border > input").val(b.legend.colors.text.rgba).trigger("change"),$("#dlgs_legend_c_bg > input").val(b.legend.colors.bg.rgba).trigger("change");let t=$("#dlgs_custom_units");t.prop("checked",b.custom_units.use),$("#dlgs_cu_major").val(b.custom_units.major),$("#dlgs_cu_minor").val(b.custom_units.minor),$("#dlgs_compass_color").colorpicker(b.compass.show?"enable":"disable"),$("#dlgs_compass_style").prop("disabled",!b.compass.show),$("#dlgs_axis_color").colorpicker(b.axis.show?"enable":"disable"),$("#dlgs_axis_style").prop("disabled",!b.axis.show),$("#dlgs_axis_ticks").prop("disabled",!b.axis.show),$("#dlgs_grid_color").colorpicker(b.grid.show?"enable":"disable"),$("#dlgs_grid_style").prop("disabled",!b.grid.show),$("#dlgs_legend_c_text").colorpicker(b.legend.show?"enable":"disable"),$("#dlgs_legend_c_border").colorpicker(b.legend.show?"enable":"disable"),$("#dlgs_legend_c_bg").colorpicker(b.legend.show?"enable":"disable");let a=s[0].parentElement.parentElement.parentElement.nextElementSibling,l=a.nextElementSibling;$(a).toggleClass("disabled",!b.legend.show),$(l).toggleClass("disabled",!b.legend.show),$("#dlgs_compass_grad_from").colorpicker(b.compass.gradient.enabled?"enable":"disable"),$("#dlgs_compass_grad_to").colorpicker(b.compass.gradient.enabled?"enable":"disable"),$(e[0].parentElement.parentElement.parentElement.nextElementSibling).toggleClass("disabled",!b.compass.gradient.enabled),$("#dlgs_cu_major").prop("disabled",!b.custom_units.use),$("#dlgs_cu_minor").prop("disabled",!b.custom_units.use),$(t[0].parentElement.parentElement.parentElement.nextElementSibling).toggleClass("disabled",!b.custom_units.use)}function n(s){let e=!$(s.target).prop("checked"),t=e?"disable":"enable";switch(s.target.id){case"dlgs_compass":{$("#dlgs_compass_color").colorpicker(t),$("#dlgs_compass_style").prop("disabled",e);break}case"dlgs_axis":{$("#dlgs_axis_color").colorpicker(t),$("#dlgs_axis_style").prop("disabled",e),$("#dlgs_axis_ticks").prop("disabled",e);break}case"dlgs_grid":{$("#dlgs_grid_color").colorpicker(t),$("#dlgs_grid_style").prop("disabled",e);break}case"dlgs_legend":{$("#dlgs_legend_c_text").colorpicker(t),$("#dlgs_legend_c_border").colorpicker(t),$("#dlgs_legend_c_bg").colorpicker(t);let a=s.target.parentElement.parentElement.parentElement.nextElementSibling,l=a.nextElementSibling;$(a).toggleClass("disabled",e),$(l).toggleClass("disabled",e);break}case"dlgs_compass_grad":{$("#dlgs_compass_grad_from").colorpicker(t),$("#dlgs_compass_grad_to").colorpicker(t),$(s.target.parentElement.parentElement.parentElement.nextElementSibling).toggleClass("disabled",e);break}case"dlgs_custom_units":{$("#dlgs_cu_major").prop("disabled",e),$("#dlgs_cu_minor").prop("disabled",e),$(s.target.parentElement.parentElement.parentElement.nextElementSibling).toggleClass("disabled",e);break}}}function c(e=!1){let s=$("#dlgs_cu_major"),t=s.val(),a=!0,l=$("#dlgs_cu_minor"),o=l.val(),r=!0,i=_.getMaxLength();try{if(""===t)throw new Error;if(t=+t,isNaN(t)||t>=2*i||0>=t||15<i/t)throw new Error}catch(t){a=!1,s.addClass("invalid_input")}try{if(!a||""===o)throw new Error;if(o=+o,isNaN(o)||0>=o||o>=t||15<t/o)throw new Error}catch(s){r=!1,l.addClass("invalid_input")}return!!(a&&r)&&(l.removeClass("invalid_input"),s.removeClass("invalid_input"),e&&(b.custom_units.major=t,b.custom_units.minor=o),!0)}function p(){let e=$("#dlgs_custom_units").prop("checked");if(e&&!c(!0))return!1;b.custom_units.use=e;let s=$("#dlgs_quadrants").prop("selectedIndex");return T.main=b.quadrants!=s,b.quadrants=s,b.compass.show=$("#dlgs_compass").prop("checked"),b.compass.style=$("#dlgs_compass_style").prop("selectedIndex"),b.compass.color.set($("#dlgs_compass_color > input").val()),b.compass.gradient.enabled=$("#dlgs_compass_grad").prop("checked"),b.compass.gradient.from.set($("#dlgs_compass_grad_from > input").val()),b.compass.gradient.to.set($("#dlgs_compass_grad_to > input").val()),b.grid.show=$("#dlgs_grid").prop("checked"),b.grid.style=$("#dlgs_grid_style").prop("selectedIndex"),b.grid.color.set($("#dlgs_grid_color > input").val()),b.axis.show=$("#dlgs_axis").prop("checked"),b.axis.style=$("#dlgs_axis_style").prop("selectedIndex"),b.axis.color.set($("#dlgs_axis_color > input").val()),b.axis.ticks=$("#dlgs_axis_ticks").prop("checked"),b.labels.xp=$("#dlgs_labels_xp").prop("checked"),b.labels.xn=$("#dlgs_labels_xn").prop("checked"),b.labels.yp=$("#dlgs_labels_yp").prop("checked"),b.labels.yn=$("#dlgs_labels_yn").prop("checked"),b.labels.angles=$("#dlgs_labels_angles").prop("checked"),b.labels.color.set($("#dlgs_labels_color > input").val()),b.labels.textsize=+$("#dlgs_labels_textsize").val(),b.legend.show=$("#dlgs_legend").prop("checked"),b.legend.colors.border.set($("#dlgs_legend_c_border > input").val()),b.legend.colors.bg.set($("#dlgs_legend_c_bg > input").val()),b.legend.colors.text.set($("#dlgs_legend_c_text > input").val()),T.legend=!0,!0}function m(){if(_.isSelectionEmpty())throw new Error("selection empty");let e=_.getSelection(),s="Do you really want to delete ";for(let t=0;t<e.length;t++)s+=0==t?"\"":t==e.length-1&&1<e.length?" and \"":", \"",s+=e[t].label+"\"";s+="?</p>",$("#dlgdel div.modal-body ").html(s)}function h(){$("#dlgload_error").html("")}function x(e){e.success?(L(!0,!0),P=B.none,$("#dlgload").modal("hide")):$("#dlgload_error").html(e.msg)}function v(){let e=document.getElementById("dlgload_file").files;1===e.length&&e[0].size<d.max_filesize&&"application/json"===e[0].type&&5<e[0].name.length&&".json"===e[0].name.substr(e[0].name.length-5,5)?y.load(e[0],x):$("#dlgload_error").html("please select a phasorviz .json file.")}function f(){let e=$("#dlgnet");var s=e.find("#dlgnet_input");"upload"==e.data("what")?(s.select(),document.execCommand("copy"),s.focus()):(navigator&&navigator.permissions&&navigator.permissions.query({name:"clipboard-read"}).then(e=>{("granted"==e.state||"prompt"==e.state)&&navigator.clipboard.readText().then(e=>s.val(e))}),s[0].focus())}function w(e){let s=$("#dlgnet"),t=s.find("button"),a=s.find("#dlgnet_input");s.data("what",e),"upload"===e?(s.find(".modal-title").html("Upload"),t.eq(1).html("Copy to clipboard").addClass("hidden"),t.eq(2).addClass("hidden"),t.eq(3).html("OK").removeClass("btn-secondary").addClass("btn-primary"),a.val("please wait...").removeClass("dlgnet_error invalid_input").prop("readonly",!0).data("val",0)):(s.find(".modal-title").html("Please enter download code"),t.eq(1).html("Copy from clipboard").removeClass("hidden"),t.eq(2).removeClass("hidden").html("Confirm"),t.eq(3).html("Cancel").removeClass("btn-primary").addClass("btn-secondary"),a.val("").removeClass("dlgnet_error invalid_input").prop("readonly",!1).prop("maxlength",6).data("val",1))}function k(){var e=$("#dlgnet"),s=e.find("#dlgnet_input"),t=e.find("#dlgnet_btn"),a=e.find(".modal-title");if("upload"==e.data("what")){var l,o,r,i="{ \"settings\" : "+JSON.stringify(b)+", \"phasors\" : "+_.stringify()+"}";d.appmode?(l=APP.getDeviceString(),o=APP.getVersion(),r=APP.getLanguage(),console.log(l,o,r)):(l=g.getBrowserString(),o=d.version,r=window.navigator.language||"?"),$.ajax({url:d.ajax_url,method:"POST",data:{action:"post",device:l,language:r,version:o,data:i},dataType:"html",timeout:2e3}).done(function(e){try{let l=JSON.parse(e);l.success?(a.html("Upload successful!"),t.removeClass("hidden"),s.val(l.code),s.focus(),s[0].setSelectionRange(0,6)):s.addClass("dlgnet_error").val(l.msg)}catch(e){s.addClass("dlgnet_error").val("an error occured")}}).fail(function(){s.addClass("dlgnet_error").val("upload failed")})}else navigator.clipboard&&navigator.permissions?navigator.permissions.query({name:"clipboard-read"}).then(e=>{"granted"!=e.state&&t.addClass("hidden")}):t.addClass("hidden"),s[0].focus()}function z(){var e=$("#dlgnet"),s=e.find("#dlgnet_input"),t=s.val();if(t.match(d.code_regex))$.ajax({url:d.ajax_url,method:"POST",data:{action:"get",code:t},dataType:"html",timeout:2e3}).done(function(e){try{let t=JSON.parse(e);t.success?u.check(t.data.settings)&&_.load(t.data.phasors)?(b.load(t.data.settings),L(!0,!0),P=B.none,$("#dlgnet").modal("hide")):s.addClass("dlgnet_error").val("invalid data"):s.addClass("dlgnet_error").val(t.msg)}catch(e){s.addClass("dlgnet_error").val("an error occured")}}).fail(function(){s.addClass("dlgnet_error").val("upload failed")});else{let e=s.val();s[0].setSelectionRange(e.length,e.length),s.focus()}}function S(s){let e=$(s.target),a=e.val();a=a.toUpperCase(),6<a.length&&(a=a.substr(6)),e.val(a),e[0].setSelectionRange(a.length,a.length),a.match(d.code_regex)?e.removeClass("invalid_input"):e.addClass("invalid_input")}function A(s){1==$(s.target).data("val")&&(s.target.value="")}function C(e){switch($("#dlgsave_name").val(d.files.default_name),e){case"png":$("#dlgsave").data("filetype","png"),$("#dlgsave_title").html("Save As PNG"),$("#dlgsave_row_size").css("display",""),$("#dlgsave_row_color").css("display",""),$("#dlgsave_width").val(d.files.png.width.default).data("min",d.files.png.width.min).data("max",d.files.png.width.max),$("#dlgsave_height").val(d.files.png.height.default).data("min",d.files.png.height.min).data("max",d.files.png.height.max),$("#dlgsave_color > input").val(d.files.png.background_color).trigger("change");break;case"svg":$("#dlgsave").data("filetype","svg"),$("#dlgsave_title").html("Save As SVG"),$("#dlgsave_row_size").css("display",""),$("#dlgsave_row_color").css("display","none"),$("#dlgsave_width").val(d.files.svg.width.default).data("min",d.files.svg.width.min).data("max",d.files.svg.width.max),$("#dlgsave_height").val(d.files.svg.height.default).data("min",d.files.svg.height.min).data("max",d.files.svg.height.max);break;case"json":$("#dlgsave").data("filetype","json"),$("#dlgsave_title").html("Save As JSON"),$("#dlgsave_row_size").css("display","none"),$("#dlgsave_row_color").css("display","none");break;default:throw new Error("invalid filetype");}}function q(){let e=N();return!!e.valid&&("png"===e.filetype?((4>e.filename.length||".png"!==e.filename.substr(e.filename.length-4))&&(e.filename+=".png"),y.savePNG(e.filename,e.width,e.height,e.color)):"svg"===e.filetype?((4>e.filename.length||".svg"!==e.filename.substr(e.filename.length-4))&&(e.filename+=".svg"),y.saveSVG(e.filename,e.width,e.height)):((5>e.filename.length||".json"!==e.filename.substr(e.filename.length-5))&&(e.filename+=".json"),y.saveJSON(e.filename)),!0)}function N(s=null){if(s){let e=$(s.target);switch(s.target.id){case"dlgsave_name":{e.toggleClass("invalid_input",0==s.target.value.length||s.target.value.length>d.files.max_name_length);break}case"dlgsave_width":case"dlgsave_height":{let s=+e.val();e.toggleClass("invalid_input",isNaN(s)||s<e.data("min")||s>e.data("max"));break}}}else{let s=$("#dlgsave_name");var e={filename:s.val(),filetype:$("#dlgsave").data("filetype"),valid:!0,color:$("#dlgsave_color > input").val()};let t=!0,a=!0,l=0<e.filename.length&&e.filename.length<=d.files.max_name_length;if(s.toggleClass("invalid_input",!l),"png"===e.filetype||"svg"===e.filetype){let s=$("#dlgsave_width"),l=$("#dlgsave_height");e.width=+s.val(),e.height=+l.val(),t=!(isNaN(e.width)||e.width<s.data("min")||e.width>s.data("max")),a=!(isNaN(e.height)||e.height<l.data("min")||e.height>l.data("max")),s.toggleClass("invalid_input",!t),l.toggleClass("invalid_input",!a)}return e.valid=l&&t&&a,e}}function E(){$("#dlginfo_t1").scrollTop(0),$("#dlginfo_t2").scrollTop(0),$("#dlginfo_t3").scrollTop(0)}function V(s){s.preventDefault(),$(this).tab("show")}function j(){setTimeout(E,10)}function I(e,s){if(!(0<P||1>e||7<e)){P=e;try{P===B.edit?(a(),$("#dlgedit").modal("show")):P===B.settings?(i(),$("#dlgsettings").modal("show")):P===B.delete?(m(),$("#dlgdel").modal("show")):P===B.load?(h(),$("#dlgload").modal("show")):P===B.save?(C(s),$("#dlgsave").modal("show")):P===B.info?(j(),$("#dlginfo").modal("show")):P===B.net?(w(s),$("#dlgnet").modal("show")):void 0}catch(s){P=B.none}}}function O(){return P!==B.none}const B={none:0,edit:1,settings:2,delete:3,load:4,save:5,info:6,net:7};Object.freeze(B);var P=B.none,L=null,T={main:!1,legend:!1};return{en:B,setup:function(a){L=a;let l,r,g,p="";for(l=$("#dlgdel"),l.modal({show:!1,keyboard:!1,backdrop:"static"}),l.on("shown.bs.modal",e),r=l.find("button"),r.eq(0).on("click",s),r.eq(1).on("click",t),r.eq(2).on("click",s),l=$("#dlgload"),l.modal({show:!1,keyboard:!1,backdrop:"static"}),l.on("shown.bs.modal",e),r=l.find("button"),r.eq(0).on("click",s),r.eq(1).on("click",t),r.eq(2).on("click",s),l=$("#dlgnet"),l.modal({show:!1,keyboard:!1,backdrop:"static"}),l.on("shown.bs.modal",e),r=l.find("button"),r.eq(0).on("click",s),r.eq(1).on("click",f),r.eq(2).on("click",t),r.eq(3).on("click",s),l.find("#dlgnet_input").on("input",S).on("focus",A),l=$("#dlgsave"),l.modal({show:!1,keyboard:!1,backdrop:"static"}),$("#dlgsave_color").colorpicker({color:"rgba(255,255,255,1)"}),l.on("shown.bs.modal",e),r=l.find("button"),r.eq(0).on("click",s),r.eq(1).on("click",t),r.eq(2).on("click",s),$("#dlgsave_name").on("input",N),$("#dlgsave_width").on("input",N),$("#dlgsave_height").on("input",N),l=$("#dlgedit"),l.modal({show:!1,keyboard:!1,backdrop:"static"}),$("#dlgedit_color").colorpicker({format:"rgba",color:"red"}),$("#dlgedit_color_ol").colorpicker({format:"rgba",color:"black"}),p="<option>None</option>",g=1;g<d.max_outline_width;g++)p+="<option>"+g+"</option>";for($("#dlgedit_ol_width").append(p),p="",g=0;g<d.arrow_types.length;g++)p+="<option>"+d.arrow_types[g].label+"</option>";for($("#dlgedit_arrow").append(p),p="",g=1;g<=d.max_phasor_width;g++)p+="<option>"+g+"</option>";for($("#dlgedit_width").append(p),p="",g=0;g<d.phasor_skins.length;g++)p+="<option>"+d.phasor_skins[g].label+"</option>";for($("#dlgedit_skin").append(p),l.find("span.oi").tooltip({placement:"top",container:"body"}),$("#dlgedit_arrowsize ").prop("min",d.arrow_size.min).prop("max",d.arrow_size.max),l.on("shown.bs.modal",e),r=l.find("button"),r.eq(0).on("click",s),r.eq(1).on("click",t),r.eq(2).on("click",s),l.find(".dlgedit_overlay").on("click",o),l.find(".dlgedit_label").on("click",o),l=$("#dlgsettings"),l.modal({show:!1,keyboard:!1,backdrop:"static"}),$("#dlgs_grid_color").colorpicker({color:b.grid.color.rgba}),$("#dlgs_axis_color").colorpicker({color:b.axis.color.rgba}),$("#dlgs_compass_color").colorpicker({color:b.compass.color.rgba}),$("#dlgs_compass_grad_from").colorpicker({color:b.compass.gradient.from.rgba}),$("#dlgs_compass_grad_to").colorpicker({color:b.compass.gradient.to.rgba}),$("#dlgs_labels_color").colorpicker({color:b.labels.color.rgba}),$("#dlgs_legend_c_text").colorpicker({color:b.legend.colors.text.rgba}),$("#dlgs_legend_c_border").colorpicker({color:b.legend.colors.border.rgba}),$("#dlgs_legend_c_bg").colorpicker({color:b.legend.colors.bg.rgba}),p="",g=0;g<d.stroke_styles.length;g++)p+="<option>"+d.stroke_styles[g].label+"</option>";$("#dlgs_compass_style").append(p),$("#dlgs_axis_style").append(p),$("#dlgs_grid_style").append(p),$("#dlgs_labels_textsize").prop("min",d.text_size.min).prop("max",d.text_size.max),l.on("shown.bs.modal",e),r=l.find("button"),r.eq(0).on("click",s),r.eq(1).on("click",t),r.eq(2).on("click",s),l.find("#dlgs_cu_major").on("input",c),l.find("#dlgs_cu_minor").on("input",c),l.find("#dlgs_compass").on("click",n),l.find("#dlgs_axis").on("click",n),l.find("#dlgs_grid").on("click",n),l.find("#dlgs_legend").on("click",n),l.find("#dlgs_compass_grad").on("click",n),l.find("#dlgs_custom_units").on("click",n),l=$("#dlginfo"),l.modal({show:!1,backdrop:"static"}),$("#dlginfo_tab a").on("click",V),l.on("shown.bs.modal",e),l.find("button").on("click",s)},show:I,isVisible:O}}();$(document).ready(function(){e()})})();
